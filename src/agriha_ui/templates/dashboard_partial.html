{# dashboard_partial.html â€” htmx partialæ›´æ–°ç”¨ï¼ˆbase.htmlã‚’ç¶™æ‰¿ã—ãªã„ï¼‰
   ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå¤‰æ•°ã¯ dashboard.html ã¨åŒä¸€:
     sensors, lockout, rule_engine, forecast, relays, last_update
#}

{# â”€â”€â”€ ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
<div class="dashboard-header">
  <h1 class="page-title">AgriHA ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
  <span class="last-update">æœ€çµ‚æ›´æ–°: {{ last_update }}</span>
</div>

{# â”€â”€â”€ ãƒ­ãƒƒã‚¯ã‚¢ã‚¦ãƒˆçŠ¶æ…‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
{% if lockout and lockout.active %}
<div class="alert alert--danger lockout-banner">
  ğŸš¨ <strong>ãƒ­ãƒƒã‚¯ã‚¢ã‚¦ãƒˆä¸­</strong> â€” {{ lockout.reason }}
  ï¼ˆæ®‹ã‚Š {{ lockout.remaining_sec }} ç§’ï¼‰
</div>
{% else %}
<div class="alert alert--success">
  âœ… <strong>æ­£å¸¸</strong> â€” ãƒ­ãƒƒã‚¯ã‚¢ã‚¦ãƒˆãªã—
</div>
{% endif %}

{# â”€â”€â”€ ä¸»è¦ã‚»ãƒ³ã‚µãƒ¼ã‚«ãƒ¼ãƒ‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
<section class="section">
  <h2 class="section__title">ã‚»ãƒ³ã‚µãƒ¼å€¤</h2>
  <div class="card-grid">

    <div class="card card--sensor">
      <div class="card__label">ğŸŒ¡ æ°—æ¸©ï¼ˆå®¤å†…ï¼‰</div>
      <div class="card__value">
        {% if sensors and sensors.get('agriha/h01/ccm/InAirTemp') %}
          {{ "%.1f"|format(sensors['agriha/h01/ccm/InAirTemp'].value) }} â„ƒ
        {% elif sensors and sensors.get('InAirTemp') %}
          {{ "%.1f"|format(sensors['InAirTemp'].value) }} â„ƒ
        {% else %}
          ---
        {% endif %}
      </div>
    </div>

    <div class="card card--sensor">
      <div class="card__label">ğŸ’§ æ¹¿åº¦ï¼ˆå®¤å†…ï¼‰</div>
      <div class="card__value">
        {% if sensors and sensors.get('agriha/h01/ccm/InAirHumi') %}
          {{ "%.1f"|format(sensors['agriha/h01/ccm/InAirHumi'].value) }} %
        {% elif sensors and sensors.get('InAirHumi') %}
          {{ "%.1f"|format(sensors['InAirHumi'].value) }} %
        {% else %}
          ---
        {% endif %}
      </div>
    </div>

    <div class="card card--sensor">
      <div class="card__label">ğŸŒ« CO2æ¿ƒåº¦</div>
      <div class="card__value">
        {% if sensors and sensors.get('agriha/h01/ccm/InCO2') %}
          {{ sensors['agriha/h01/ccm/InCO2'].value|int }} ppm
        {% elif sensors and sensors.get('InCO2') %}
          {{ sensors['InCO2'].value|int }} ppm
        {% else %}
          ---
        {% endif %}
      </div>
    </div>

    <div class="card card--sensor">
      <div class="card__label">â˜€ æ—¥å°„é‡</div>
      <div class="card__value">
        {% if sensors and sensors.get('agriha/h01/ccm/InSolar') %}
          {{ sensors['agriha/h01/ccm/InSolar'].value|int }} W/mÂ²
        {% elif sensors and sensors.get('InSolar') %}
          {{ sensors['InSolar'].value|int }} W/mÂ²
        {% else %}
          ---
        {% endif %}
      </div>
    </div>

    <div class="card card--sensor">
      <div class="card__label">ğŸŒ± åœŸå£Œæ°´åˆ†</div>
      <div class="card__value">
        {% if sensors and sensors.get('SoilMoisture') %}
          {{ "%.1f"|format(sensors['SoilMoisture'].value) }} %
        {% else %}
          ---
        {% endif %}
      </div>
    </div>

    <div class="card card--sensor">
      <div class="card__label">ğŸ’¦ æ’æ°´é‡</div>
      <div class="card__value">
        {% if sensors and sensors.get('DrainFlow') %}
          {{ "%.1f"|format(sensors['DrainFlow'].value) }} L
        {% else %}
          ---
        {% endif %}
      </div>
    </div>

  </div>{# /card-grid #}

  {# ãã®ä»–ã®ã‚»ãƒ³ã‚µãƒ¼ #}
  {% set known_keys = [
    'agriha/h01/ccm/InAirTemp', 'agriha/h01/ccm/InAirHumi',
    'agriha/h01/ccm/InCO2', 'agriha/h01/ccm/InSolar',
    'InAirTemp', 'InAirHumi', 'InCO2', 'InSolar',
    'SoilMoisture', 'DrainFlow'
  ] %}
  {% if sensors %}
    {% set other_sensors = sensors.items() | selectattr('0', 'not in', known_keys) | list %}
    {% if other_sensors %}
    <details class="other-sensors">
      <summary>ãã®ä»–ã®ã‚»ãƒ³ã‚µãƒ¼ï¼ˆ{{ other_sensors | length }} ä»¶ï¼‰</summary>
      <table class="table">
        <thead>
          <tr><th>ã‚»ãƒ³ã‚µãƒ¼ã‚­ãƒ¼</th><th>å€¤</th></tr>
        </thead>
        <tbody>
          {% for key, data in other_sensors %}
          <tr>
            <td>{{ key }}</td>
            <td>{{ data.value if data.value is not none else '---' }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </details>
    {% endif %}
  {% endif %}
</section>

{# â”€â”€â”€ ä¸‰å±¤åˆ¶å¾¡çŠ¶æ…‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
<section class="section">
  <h2 class="section__title">åˆ¶å¾¡ãƒ¬ã‚¤ãƒ¤ãƒ¼çŠ¶æ…‹</h2>
  <div class="layer-status">

    <div class="layer-card layer-card--layer1">
      <div class="layer-card__header">
        <span class="layer-badge layer-badge--1">Layer 1</span>
        <span class="layer-card__name">ç·Šæ€¥åˆ¶å¾¡</span>
      </div>
      <div class="layer-card__body">
        {% if lockout and lockout.active %}
          <span class="status-dot status-dot--danger"></span>
          ãƒ­ãƒƒã‚¯ã‚¢ã‚¦ãƒˆä¸­ï¼ˆæ®‹ã‚Š {{ lockout.remaining_sec }}ç§’ï¼‰
        {% else %}
          <span class="status-dot status-dot--ok"></span>
          å¾…æ©Ÿä¸­
        {% endif %}
      </div>
    </div>

    <div class="layer-card layer-card--layer2">
      <div class="layer-card__header">
        <span class="layer-badge layer-badge--2">Layer 2</span>
        <span class="layer-card__name">ãƒ«ãƒ¼ãƒ«åˆ¶å¾¡</span>
      </div>
      <div class="layer-card__body">
        {% if rule_engine %}
          <div>æœ€çµ‚å®Ÿè¡Œ: {{ rule_engine.last_run }}</div>
          {% if rule_engine.actions %}
            <ul class="action-list">
              {% for act in rule_engine.actions %}
                <li>{{ act }}</li>
              {% endfor %}
            </ul>
          {% else %}
            <span class="text-muted">ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãªã—</span>
          {% endif %}
        {% else %}
          <span class="text-muted">ãƒ‡ãƒ¼ã‚¿ãªã—</span>
        {% endif %}
      </div>
    </div>

    <div class="layer-card layer-card--layer3">
      <div class="layer-card__header">
        <span class="layer-badge layer-badge--3">Layer 3</span>
        <span class="layer-card__name">LLMäºˆå ±</span>
      </div>
      <div class="layer-card__body">
        {% if forecast %}
          <div>ç”Ÿæˆ: {{ forecast.generated_at }}</div>
          <div>{{ forecast.summary }}</div>
          <div class="text-muted">ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ {{ forecast.action_count }} ä»¶</div>
        {% else %}
          <span class="text-muted">äºˆå ±ãªã—</span>
        {% endif %}
      </div>
    </div>

  </div>{# /layer-status #}
</section>

{# â”€â”€â”€ ãƒªãƒ¬ãƒ¼çŠ¶æ…‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
<section class="section">
  <h2 class="section__title">ãƒªãƒ¬ãƒ¼çŠ¶æ…‹</h2>
  <div class="relay-grid">
    {% if relays %}
      {% for ch in range(1, 9) %}
        {% set ch_key = 'ch' ~ ch %}
        {% set state = relays.get(ch_key) %}
        <div class="relay-chip {% if state %}relay-chip--on{% else %}relay-chip--off{% endif %}">
          <span class="relay-chip__label">ch{{ ch }}</span>
          <span class="relay-chip__state">{{ 'ON' if state else 'OFF' }}</span>
        </div>
      {% endfor %}
    {% else %}
      <span class="text-muted">ãƒªãƒ¬ãƒ¼æƒ…å ±ãªã—</span>
    {% endif %}
  </div>
</section>
