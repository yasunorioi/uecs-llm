# =============================================================================
# Telegraf Configuration — AgriHA MQTT→InfluxDB ブリッジ
# =============================================================================
# Data Flow:
#   Sensor Nodes → Mosquitto (MQTT on RPi) → VPN → Telegraf → InfluxDB → Grafana
#
# MQTT Topic Pattern:
#   greenhouse/{house_id}/sensor/{sensor_type}
#   greenhouse/{house_id}/irrigation/event
#
# Payload Format (JSON):
#   {"value": 25.0, "sensor_type": "temperature", "source": "pico_node_01",
#    "house_id": "h1", "location": "indoor", "unit": "C"}

# -----------------------------------------------------------------------------
# Agent Configuration
# -----------------------------------------------------------------------------
[agent]
  interval = "10s"
  round_interval = true
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  collection_jitter = "0s"
  flush_interval = "10s"
  flush_jitter = "0s"
  precision = ""
  hostname = ""
  omit_hostname = false

# -----------------------------------------------------------------------------
# MQTT Consumer — センサーデータ
# -----------------------------------------------------------------------------
[[inputs.mqtt_consumer]]
  servers = ["tcp://${MQTT_BROKER_HOST}:1883"]

  topics = [
    "greenhouse/#"
  ]

  qos = 0
  connection_timeout = "30s"
  max_undelivered_messages = 1000
  persistent_session = false
  client_id = ""

  data_format = "json"
  json_string_fields = ["sensor_type", "source", "house_id", "location", "unit"]
  tag_keys = ["source", "sensor_type", "house_id", "location"]
  topic_tag = "topic"
  json_name_key = ""
  name_override = "greenhouse_data"

  [[inputs.mqtt_consumer.topic_parsing]]
    topic = "greenhouse/+/sensor/+"
    measurement = ""
    tags = ""

# -----------------------------------------------------------------------------
# MQTT Consumer — 灌水イベント
# -----------------------------------------------------------------------------
[[inputs.mqtt_consumer]]
  servers = ["tcp://${MQTT_BROKER_HOST}:1883"]

  topics = [
    "greenhouse/+/irrigation/event"
  ]

  qos = 0
  connection_timeout = "30s"
  max_undelivered_messages = 1000
  persistent_session = false
  client_id = "telegraf_irrigation"

  data_format = "json"
  json_string_fields = ["source", "status", "house_id"]
  tag_keys = ["house_id", "source", "status"]
  topic_tag = "topic"
  name_override = "irrigation_events"

  [[inputs.mqtt_consumer.topic_parsing]]
    topic = "greenhouse/+/irrigation/event"
    measurement = ""
    tags = ""

# -----------------------------------------------------------------------------
# InfluxDB v2 Output
# -----------------------------------------------------------------------------
[[outputs.influxdb_v2]]
  urls = ["http://influxdb:8086"]
  token = "$INFLUXDB_TOKEN"
  organization = "agriha"
  bucket = "sensors"
  timeout = "5s"
  user_agent = "telegraf"
