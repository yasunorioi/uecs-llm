# =============================================================================
# Telegraf Configuration — AgriHA MQTT→InfluxDB ブリッジ
# =============================================================================
# Data Flow:
#   RPi (unipi-daemon) → Mosquitto (MQTT) → VPN → Telegraf → InfluxDB → Grafana
#
# MQTT Topic Structure:
#   agriha/{house_id}/ccm/sensor/{ccm_type}  — CCMセンサー (InAirTemp, InAirHumid等)
#   agriha/{house_id}/ccm/other/{type}        — CCM制御フラグ (testFLOW, cnd等)
#   agriha/{house_id}/sensor/DS18B20          — DS18B20温度センサー
#   agriha/{house_id}/relay/state             — リレー状態 (ch1-ch8)
#   agriha/farm/weather/misol                 — Misol WH65LP 気象センサー
#
# InfluxDB Measurements:
#   ccm_sensor     — CCMセンサー値 (tag: ccm_type)
#   ccm_control    — CCM制御フラグ (tag: ccm_type)
#   ds18b20        — 1-Wire温度 (tag: device_id)
#   relay_state    — リレー状態 (fields: ch1-ch8)
#   weather_misol  — 気象データ (temperature_c, humidity_pct, wind_speed_ms等)

# -----------------------------------------------------------------------------
# Agent Configuration
# -----------------------------------------------------------------------------
[agent]
  interval = "10s"
  round_interval = true
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  collection_jitter = "0s"
  flush_interval = "10s"
  flush_jitter = "0s"
  precision = ""
  hostname = ""
  omit_hostname = false

# -----------------------------------------------------------------------------
# MQTT Consumer — CCM センサーデータ
# agriha/{house_id}/ccm/sensor/{ccm_type}
# Payload: {"ccm_type": "InAirTemp", "value": 6.5, "room": 1, ...}
# -----------------------------------------------------------------------------
[[inputs.mqtt_consumer]]
  servers = ["tcp://${MQTT_BROKER_HOST}:1883"]
  topics = ["agriha/+/ccm/sensor/+"]
  qos = 0
  connection_timeout = "30s"
  max_undelivered_messages = 1000
  persistent_session = false
  client_id = "telegraf_ccm_sensor"

  data_format = "json"
  json_string_fields = ["ccm_type", "source_ip", "level", "timestamp"]
  tag_keys = ["ccm_type", "source_ip"]
  topic_tag = "topic"
  name_override = "ccm_sensor"

# -----------------------------------------------------------------------------
# MQTT Consumer — CCM 制御フラグ
# agriha/{house_id}/ccm/other/{type}
# Payload: {"ccm_type": "cnd", "value": 0.0, ...}
# -----------------------------------------------------------------------------
[[inputs.mqtt_consumer]]
  servers = ["tcp://${MQTT_BROKER_HOST}:1883"]
  topics = ["agriha/+/ccm/other/+"]
  qos = 0
  connection_timeout = "30s"
  max_undelivered_messages = 1000
  persistent_session = false
  client_id = "telegraf_ccm_other"

  data_format = "json"
  json_string_fields = ["ccm_type", "source_ip", "level", "timestamp"]
  tag_keys = ["ccm_type", "source_ip"]
  topic_tag = "topic"
  name_override = "ccm_control"

# -----------------------------------------------------------------------------
# MQTT Consumer — DS18B20 温度センサー
# agriha/{house_id}/sensor/DS18B20
# Payload: {"device_id": "28-xxx", "temperature_c": 4.25, "timestamp": ...}
# -----------------------------------------------------------------------------
[[inputs.mqtt_consumer]]
  servers = ["tcp://${MQTT_BROKER_HOST}:1883"]
  topics = ["agriha/+/sensor/DS18B20"]
  qos = 0
  connection_timeout = "30s"
  max_undelivered_messages = 1000
  persistent_session = false
  client_id = "telegraf_ds18b20"

  data_format = "json"
  json_string_fields = ["device_id"]
  tag_keys = ["device_id"]
  topic_tag = "topic"
  name_override = "ds18b20"

# -----------------------------------------------------------------------------
# MQTT Consumer — リレー状態
# agriha/{house_id}/relay/state
# Payload: {"ch1": 0, "ch2": 0, ..., "ch8": 0, "ts": ...}
# -----------------------------------------------------------------------------
[[inputs.mqtt_consumer]]
  servers = ["tcp://${MQTT_BROKER_HOST}:1883"]
  topics = ["agriha/+/relay/state"]
  qos = 0
  connection_timeout = "30s"
  max_undelivered_messages = 1000
  persistent_session = false
  client_id = "telegraf_relay"

  data_format = "json"
  topic_tag = "topic"
  name_override = "relay_state"

# -----------------------------------------------------------------------------
# MQTT Consumer — Misol 気象センサー
# agriha/farm/weather/misol
# Payload: {"wind_dir_deg": 142, "temperature_c": 6.0, "humidity_pct": 94,
#           "wind_speed_ms": 0.0, "wind_gust_ms": 0.0, "rainfall_mm": 0.0,
#           "uv_index": 0, "light_lux": 0, "pressure_hpa": 1019.0}
# -----------------------------------------------------------------------------
[[inputs.mqtt_consumer]]
  servers = ["tcp://${MQTT_BROKER_HOST}:1883"]
  topics = ["agriha/farm/weather/misol"]
  qos = 0
  connection_timeout = "30s"
  max_undelivered_messages = 1000
  persistent_session = false
  client_id = "telegraf_misol"

  data_format = "json"
  json_string_fields = []
  topic_tag = "topic"
  name_override = "weather_misol"

# -----------------------------------------------------------------------------
# InfluxDB v2 Output
# -----------------------------------------------------------------------------
[[outputs.influxdb_v2]]
  urls = ["http://influxdb:8086"]
  token = "$INFLUXDB_TOKEN"
  organization = "agriha"
  bucket = "sensors"
  timeout = "5s"
  user_agent = "telegraf"
