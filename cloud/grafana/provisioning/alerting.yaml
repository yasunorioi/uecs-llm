# =============================================================================
# Grafana Alerting Provisioning Configuration
# =============================================================================
# Greenhouse Ê∏©ÂÆ§Áõ£Ë¶ñ„Ç¢„É©„Éº„ÉàË®≠ÂÆö
#
# ‰ΩøÁî®ÊñπÊ≥ï:
#   docker compose restart grafana „ÅßÂÖ®Ë®≠ÂÆö„ÅåÂèçÊò†„Åï„Çå„Çã
#
# Ê≥®ÊÑè:
#   - LINE_CHANNEL_ACCESS_TOKEN, LINE_USER_ID „ÅØÁí∞Â¢ÉÂ§âÊï∞„ÅßË®≠ÂÆöÔºàdocker-compose.yaml „ÅÆ env_fileÔºâ
#   - datasourceUid „ÅØ influxdb.yaml „ÅÆ uid: influxdb-agriha „Å®‰∏ÄËá¥
#   - Custom Payload Ê©üËÉΩ„ÅØ Grafana v12.0+ „ÅßÂà©Áî®ÂèØËÉΩÔºàgrafana/grafana-oss:latest „ÅßÂØæÂøúÔºâ
#   - ÈñæÂÄ§„ÅØ‰ªÆÂÄ§„ÄÇÊÆø„ÅåÂæå„ÅßË™øÊï¥„Åô„ÇãÂâçÊèê
#   - sensor_type „Çø„Ç∞„ÅØ MQTT „Éà„Éî„ÉÉ„ÇØ„Åã„ÇâÊäΩÂá∫Ôºàtelegraf topic_parsingÔºâ
# =============================================================================

apiVersion: 1

# -----------------------------------------------------------------------------
# Contact PointsÔºàÈÄöÁü•ÂÖàÔºâ
# -----------------------------------------------------------------------------
contactPoints:
  - orgId: 1
    name: LINE
    receivers:
      - uid: line-webhook
        type: webhook
        settings:
          url: https://api.line.me/v2/bot/message/push
          httpMethod: POST
          authorization_scheme: Bearer
          authorization_credentials: ${LINE_CHANNEL_ACCESS_TOKEN}
          maxAlerts: 0
          # Custom PayloadÔºàGrafana v12.0+, PR #103818Ôºâ
          # LINE Messaging API Push Message ÂΩ¢Âºè„ÅßÈÄÅ‰ø°
          payload:
            template: |-
              {"to":"{{ .Vars.line_user_id }}","messages":[{"type":"text","text":"{{ .CommonAnnotations.summary }}\n\n{{ .CommonAnnotations.description }}"}]}
            vars:
              line_user_id: ${LINE_USER_ID}
        disableResolveMessage: false

# -----------------------------------------------------------------------------
# Notification PoliciesÔºàÈÄöÁü•„Éù„É™„Ç∑„ÉºÔºâ
# -----------------------------------------------------------------------------
policies:
  - orgId: 1
    receiver: LINE
    group_by:
      - alertname
      - house_id
    group_wait: 30s
    group_interval: 5m
    repeat_interval: 1h
    routes:
      # È´òÊ∏©Ë≠¶Â†±: 30ÂàÜÈñìÈöî
      - receiver: LINE
        matchers:
          - alertname = È´òÊ∏©Ë≠¶Â†±
        group_wait: 30s
        group_interval: 5m
        repeat_interval: 30m
        continue: false

      # ‰ΩéÊ∏©Ë≠¶Â†±: 30ÂàÜÈñìÈöî
      - receiver: LINE
        matchers:
          - alertname = ‰ΩéÊ∏©Ë≠¶Â†±
        group_wait: 30s
        group_interval: 5m
        repeat_interval: 30m
        continue: false

      # È´òÊπøÂ∫¶Ë≠¶Â†±: 1ÊôÇÈñìÈñìÈöî
      - receiver: LINE
        matchers:
          - alertname = È´òÊπøÂ∫¶Ë≠¶Â†±
        group_wait: 30s
        group_interval: 5m
        repeat_interval: 1h
        continue: false

      # ÈÄö‰ø°Êñ≠: 30ÂàÜÈñìÈöîÔºàÊó©ÊúüÂØæÂøúÈáçË¶ñÔºâ
      - receiver: LINE
        matchers:
          - alertname = ÈÄö‰ø°Êñ≠
        group_wait: 30s
        group_interval: 5m
        repeat_interval: 30m
        continue: false

      # ÁÅåÊ∞¥Áï∞Â∏∏: 1ÊôÇÈñìÈñìÈöî
      - receiver: LINE
        matchers:
          - alertname = ÁÅåÊ∞¥Áï∞Â∏∏
        group_wait: 30s
        group_interval: 5m
        repeat_interval: 1h
        continue: false

      # Êó•Ê¨°„É¨„Éù„Éº„Éà: 1Êó•1Âõû
      - receiver: LINE
        matchers:
          - alertname = Êó•Ê¨°„É¨„Éù„Éº„Éà
        group_wait: 10s
        group_interval: 1d
        repeat_interval: 1d
        continue: false

# -----------------------------------------------------------------------------
# Mute TimingsÔºàÈÄöÁü•ÊäëÂà∂ÊôÇÈñìÂ∏ØÔºâ
# -----------------------------------------------------------------------------
muteTimes:
  - orgId: 1
    name: Â§úÈñìÊäëÂà∂Ôºà22ÊôÇ-24ÊôÇÔºâ
    time_intervals:
      - times:
          - start_time: "22:00"
            end_time: "23:59"
        weekdays:
          - sunday
          - monday
          - tuesday
          - wednesday
          - thursday
          - friday
          - saturday
  - orgId: 1
    name: Â§úÈñìÊäëÂà∂Ôºà0ÊôÇ-6ÊôÇÔºâ
    time_intervals:
      - times:
          - start_time: "00:00"
            end_time: "06:00"
        weekdays:
          - sunday
          - monday
          - tuesday
          - wednesday
          - thursday
          - friday
          - saturday

# -----------------------------------------------------------------------------
# Alert RulesÔºà„Ç¢„É©„Éº„Éà„É´„Éº„É´Ôºâ
# -----------------------------------------------------------------------------
# datasourceUid: influxdb-agrihaÔºàinfluxdb.yaml „ÅßÂÆöÁæ©Ôºâ
# bucket: sensors / measurement: greenhouse_dataÔºàtelegraf.conf „ÅÆ name_overrideÔºâ
# sensor_type „Çø„Ç∞: MQTT „Éà„Éî„ÉÉ„ÇØ greenhouse/{house_id}/sensor/{sensor_type} „Åã„ÇâÊäΩÂá∫
# _field: "value"ÔºàJSON payload „ÅÆÊï∞ÂÄ§„Éï„Ç£„Éº„É´„ÉâÔºâ
# ÈñæÂÄ§„ÅØ‰ªÆÂÄ§„ÄÇÊÆø„ÅåÂæå„ÅßË™øÊï¥„Åô„ÇãÂâçÊèê„ÄÇ
# -----------------------------------------------------------------------------

groups:
  # ==========================================================================
  # Group 1: Ê∏©ÂÆ§Áí∞Â¢ÉÁõ£Ë¶ñÔºàË©ï‰æ°ÈñìÈöî: 1ÂàÜÔºâ
  # ==========================================================================
  - orgId: 1
    name: Ê∏©ÂÆ§Áí∞Â¢ÉÁõ£Ë¶ñ
    folder: Greenhouse
    interval: 1m
    rules:
      # -----------------------------------------------------------------------
      # Rule 1: È´òÊ∏©Ë≠¶Â†±ÔºàInAirTemp > 35‚ÑÉ, 5ÂàÜÈñìÊåÅÁ∂ö„ÅßÁô∫Â†±Ôºâ
      # -----------------------------------------------------------------------
      - uid: greenhouse-high-temp
        title: È´òÊ∏©Ë≠¶Â†±
        condition: C
        data:
          - refId: A
            queryType: ""
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: influxdb-agriha
            model:
              query: |
                from(bucket: "sensors")
                  |> range(start: -5m)
                  |> filter(fn: (r) => r._measurement == "greenhouse_data")
                  |> filter(fn: (r) => r.sensor_type == "InAirTemp")
                  |> filter(fn: (r) => r._field == "value")
                  |> last()
          - refId: B
            queryType: ""
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              reducer: last
              type: reduce
          - refId: C
            queryType: ""
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 35
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - B
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: B
              type: threshold
        noDataState: OK
        execErrState: Alerting
        for: 5m
        annotations:
          summary: "üö® È´òÊ∏©Ë≠¶Â†± {{ $values.B.Value }}‚ÑÉ"
          description: "„Éè„Ç¶„Çπ: {{ $labels.house_id }} / ÈñæÂÄ§: 35‚ÑÉË∂ÖÈÅé / ÂØæÂøú: ÊèõÊ∞óÊâá„ÉªÈÅÆÂÖâ„ÇíÁ¢∫Ë™ç"
        labels:
          severity: critical
        isPaused: false

      # -----------------------------------------------------------------------
      # Rule 2: ‰ΩéÊ∏©Ë≠¶Â†±ÔºàInAirTemp < 5‚ÑÉ, 5ÂàÜÈñìÊåÅÁ∂ö„ÅßÁô∫Â†±Ôºâ
      # -----------------------------------------------------------------------
      - uid: greenhouse-low-temp
        title: ‰ΩéÊ∏©Ë≠¶Â†±
        condition: C
        data:
          - refId: A
            queryType: ""
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: influxdb-agriha
            model:
              query: |
                from(bucket: "sensors")
                  |> range(start: -5m)
                  |> filter(fn: (r) => r._measurement == "greenhouse_data")
                  |> filter(fn: (r) => r.sensor_type == "InAirTemp")
                  |> filter(fn: (r) => r._field == "value")
                  |> last()
          - refId: B
            queryType: ""
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              reducer: last
              type: reduce
          - refId: C
            queryType: ""
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 5
                    type: lt
                  operator:
                    type: and
                  query:
                    params:
                      - B
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: B
              type: threshold
        noDataState: OK
        execErrState: Alerting
        for: 5m
        annotations:
          summary: "ü•∂ ‰ΩéÊ∏©Ë≠¶Â†± {{ $values.B.Value }}‚ÑÉ"
          description: "„Éè„Ç¶„Çπ: {{ $labels.house_id }} / ÈñæÂÄ§: 5‚ÑÉÊú™Ê∫Ä / ÂØæÂøú: ÊöñÊàø„Éª‰øùÊ∏©„ÇíÁ¢∫Ë™ç"
        labels:
          severity: critical
        isPaused: false

      # -----------------------------------------------------------------------
      # Rule 3: È´òÊπøÂ∫¶Ë≠¶Â†±ÔºàInAirHumid > 95%, 10ÂàÜÈñìÊåÅÁ∂ö„ÅßÁô∫Â†±Ôºâ
      # -----------------------------------------------------------------------
      - uid: greenhouse-high-humid
        title: È´òÊπøÂ∫¶Ë≠¶Â†±
        condition: C
        data:
          - refId: A
            queryType: ""
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: influxdb-agriha
            model:
              query: |
                from(bucket: "sensors")
                  |> range(start: -5m)
                  |> filter(fn: (r) => r._measurement == "greenhouse_data")
                  |> filter(fn: (r) => r.sensor_type == "InAirHumid")
                  |> filter(fn: (r) => r._field == "value")
                  |> last()
          - refId: B
            queryType: ""
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              reducer: last
              type: reduce
          - refId: C
            queryType: ""
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 95
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - B
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: B
              type: threshold
        noDataState: OK
        execErrState: Alerting
        for: 10m
        annotations:
          summary: "üíß È´òÊπøÂ∫¶Ë≠¶Â†± {{ $values.B.Value }}%"
          description: "„Éè„Ç¶„Çπ: {{ $labels.house_id }} / ÈñæÂÄ§: 95%Ë∂ÖÈÅé / ÂØæÂøú: ÊèõÊ∞ó„ÇíÁ¢∫Ë™ç"
        labels:
          severity: warning
        isPaused: false

      # -----------------------------------------------------------------------
      # Rule 4: ÈÄö‰ø°Êñ≠ÔºàÂÖ®„Çª„É≥„Çµ„Éº„Åã„Çâ5ÂàÜ‰ª•‰∏ä„Éá„Éº„ÇøÂèó‰ø°„Å™„ÅóÔºâ
      # -----------------------------------------------------------------------
      - uid: greenhouse-comm-lost
        title: ÈÄö‰ø°Êñ≠
        condition: C
        data:
          - refId: A
            queryType: ""
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: influxdb-agriha
            model:
              query: |
                from(bucket: "sensors")
                  |> range(start: -5m)
                  |> filter(fn: (r) => r._measurement == "greenhouse_data")
                  |> filter(fn: (r) => r._field == "value")
                  |> group()
                  |> count()
          - refId: B
            queryType: ""
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              reducer: last
              type: reduce
          - refId: C
            queryType: ""
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 1
                    type: lt
                  operator:
                    type: and
                  query:
                    params:
                      - B
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: B
              type: threshold
        noDataState: Alerting
        execErrState: Alerting
        for: 5m
        annotations:
          summary: "üì° ÈÄö‰ø°Êñ≠"
          description: "ÂÖ®„Çª„É≥„Çµ„Éº„Åã„Çâ„ÅÆ„Éá„Éº„ÇøÂèó‰ø°„Åå5ÂàÜ‰ª•‰∏äÈÄîÁµ∂ / ÂØæÂøú: „Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Éª„Éé„Éº„ÉâÈõªÊ∫ê„ÇíÁ¢∫Ë™ç"
        labels:
          severity: critical
        isPaused: false

  # ==========================================================================
  # Group 2: ÁÅåÊ∞¥Áõ£Ë¶ñÔºàË©ï‰æ°ÈñìÈöî: 5ÂàÜÔºâ
  # ==========================================================================
  - orgId: 1
    name: ÁÅåÊ∞¥Áõ£Ë¶ñ
    folder: Greenhouse
    interval: 5m
    rules:
      # -----------------------------------------------------------------------
      # Rule 5: ÁÅåÊ∞¥Áï∞Â∏∏ÔºàÁÅåÊ∞¥„Éï„É©„Ç∞„Åå30ÂàÜ‰ª•‰∏äÁ∂ôÁ∂öONÔºâ
      # -----------------------------------------------------------------------
      - uid: greenhouse-irrigation-anomaly
        title: ÁÅåÊ∞¥Áï∞Â∏∏
        condition: C
        data:
          - refId: A
            queryType: ""
            relativeTimeRange:
              from: 1800
              to: 0
            datasourceUid: influxdb-agriha
            model:
              query: |
                from(bucket: "sensors")
                  |> range(start: -30m)
                  |> filter(fn: (r) => r._measurement == "greenhouse_data")
                  |> filter(fn: (r) => r.sensor_type == "Irriopr")
                  |> filter(fn: (r) => r._field == "value")
                  |> min()
          - refId: B
            queryType: ""
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              reducer: last
              type: reduce
          - refId: C
            queryType: ""
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 0.5
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - B
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: B
              type: threshold
        noDataState: OK
        execErrState: Alerting
        for: 30m
        annotations:
          summary: "‚ö†Ô∏è ÁÅåÊ∞¥Áï∞Â∏∏"
          description: "ÁÅåÊ∞¥„Åå30ÂàÜ‰ª•‰∏äÁ∂ôÁ∂ö‰∏≠ / ÂØæÂøú: „Éê„É´„Éñ„ÉªÁÅåÊ∞¥Âà∂Âæ°„ÇíÁ¢∫Ë™ç"
        labels:
          severity: warning
        isPaused: false

  # ==========================================================================
  # Group 3: Êó•Ê¨°„É¨„Éù„Éº„ÉàÔºàË©ï‰æ°ÈñìÈöî: 10ÂàÜÔºâ
  # ==========================================================================
  - orgId: 1
    name: Êó•Ê¨°„É¨„Éù„Éº„Éà
    folder: Greenhouse
    interval: 10m
    rules:
      # -----------------------------------------------------------------------
      # Rule 6: Êó•Ê¨°„É¨„Éù„Éº„ÉàÔºàÊØéÊó•1Âõû„Çµ„Éû„É™ÈÄöÁü•Ôºâ
      # Notification Policy „ÅÆ repeat_interval: 1d „Åß1Êó•1ÂõûÈÄÅ‰ø°
      # -----------------------------------------------------------------------
      - uid: greenhouse-daily-report
        title: Êó•Ê¨°„É¨„Éù„Éº„Éà
        condition: C
        data:
          - refId: A
            queryType: ""
            relativeTimeRange:
              from: 86400
              to: 0
            datasourceUid: influxdb-agriha
            model:
              query: |
                from(bucket: "sensors")
                  |> range(start: -24h)
                  |> filter(fn: (r) => r._measurement == "greenhouse_data")
                  |> filter(fn: (r) => r.sensor_type == "InAirTemp")
                  |> filter(fn: (r) => r._field == "value")
                  |> last()
          - refId: B
            queryType: ""
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              reducer: last
              type: reduce
          - refId: C
            queryType: ""
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - -100
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - B
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: B
              type: threshold
        noDataState: OK
        execErrState: Alerting
        for: 0s
        annotations:
          summary: "üìä Êó•Ê¨°„É¨„Éù„Éº„Éà"
          description: "ÊúÄÊñ∞Ê∏©Â∫¶: {{ $values.B.Value }}‚ÑÉ / „Ç∑„Çπ„ÉÜ„É†Ê≠£Â∏∏Á®ºÂÉç‰∏≠"
        labels:
          severity: info
        isPaused: false
