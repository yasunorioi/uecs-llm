# LLMæ¸©å®¤åˆ¶å¾¡ãƒ«ãƒ¼ãƒ—è¨­è¨ˆæ›¸

> **Version**: 3.0
> **Date**: 2026-02-28
> **Status**: Draft
> **HW**: RPi (ArSprout RPi, 10.10.0.10, Raspbian Lite, WireGuard VPN)

---

## æ¦‚è¦

### è¨­è¨ˆæ€æƒ³: ä¸‰å±¤æ§‹é€ ï¼ˆä¸‹ã»ã©ç¢ºå®Ÿã€ã©ã®å±¤ãŒæ¬ ã‘ã¦ã‚‚ä¸‹ãŒæ”¯ãˆã‚‹ï¼‰

æœ¬ã‚·ã‚¹ãƒ†ãƒ ã¯æ¸©å®¤åˆ¶å¾¡ã‚’**ä¸‰å±¤æ§‹é€ **ã§è¨­è¨ˆã™ã‚‹ã€‚
å„å±¤ã¯ç‹¬ç«‹ã—ã¦å‹•ä½œã—ã€ä¸Šä½å±¤ãŒæ¬ ã‘ã¦ã‚‚ä¸‹ä½å±¤ã ã‘ã§å®‰å…¨ã«ç¨¼åƒã™ã‚‹ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 3: çŸ¥æµï¼ˆLLMï¼‰                                    â”‚
â”‚    cron æ¯æ™‚ â†’ Claude Haiku API â†’ 1æ™‚é–“ã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¨ˆç”»    â”‚
â”‚    CO2åˆ¶å¾¡ã¨éœ²ç‚¹åˆ¤æ–­ã®ã¿ã€‚é€šå¸¸24å›/æ—¥+ç·Šæ€¥æ•°å›           â”‚
â”‚    system_prompt.txt ãŒæœ¬ä½“ã€‚æœˆæ•°ç™¾å††                     â”‚
â”‚    â†’ æ¬ ã‘ãŸå ´åˆ: Layer 2ã®ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã§95%å›ã‚‹          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Layer 2: ã‚¬ãƒ ãƒ†ï¼ˆãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ï¼‰                          â”‚
â”‚    cron + æ—¥å°„æ¯”ä¾‹çŒæ°´ + æ¸©åº¦é–¾å€¤å´çª“ + é‡ã¿è£œæ­£          â”‚
â”‚    æ—¥å¸¸ã®95%ã‚’ã‚«ãƒãƒ¼ã€‚LLMãªã—ã§ã‚‚å‹•ã                     â”‚
â”‚    â†’ æ¬ ã‘ãŸå ´åˆ: Layer 1ã®ç·Šæ€¥åœæ­¢ã§æœ€ä½é™ã®å®‰å…¨ç¢ºä¿     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Layer 1: çˆ†ç™ºï¼ˆç·Šæ€¥åœæ­¢ï¼‰                                â”‚
â”‚    ifæ–‡ + LINE curlã€‚27â„ƒè¶…ã§å…¨é–‹ã€16â„ƒä»¥ä¸‹ã§å…¨é–‰          â”‚
â”‚    LLMã‚‚ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã‚‚é–¢ä¿‚ãªã—ã€‚å•ç­”ç„¡ç”¨ã§ç‰©ç†çš„ã«å‹•ã    â”‚
â”‚    â†’ æœ€çµ‚é˜²å£ã€‚ä½•ãŒã‚ã£ã¦ã‚‚å‹•ã                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ©Ÿèƒ½ã®å„ªå…ˆé †ä½ï¼ˆ2026-02-28æ®¿æ˜è¨€ï¼‰

| å„ªå…ˆåº¦ | æ©Ÿèƒ½ | çŠ¶æ…‹ |
|--------|------|------|
| 1 | ã€Œé–‹ã‘ã‚/é–‰ã‚ã‚ã€ãƒªãƒ¢ãƒ¼ãƒˆåˆ¶å¾¡ | **ç¨¼åƒæ¸ˆ** |
| 2 | ã€Œä»Šã©ã†ãªã£ã¦ã‚‹ï¼Ÿã€çŠ¶æ…‹ç¢ºèª | **ç¨¼åƒæ¸ˆ** |
| 3 | ç•°å¸¸å€¤ã®æ—©æœŸé€šçŸ¥ | æœªå®Ÿè£… |
| 4 | è‡ªå‹•åˆ¶å¾¡ï¼ˆæœ¬è¨­è¨ˆæ›¸ã®ä¸»é¡Œï¼‰ | è¨­è¨ˆä¸­ |

### ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“å›³

```
ArSprout è¦³æ¸¬ãƒãƒ¼ãƒ‰ (192.168.1.70)
    â”‚  CCMãƒãƒ«ãƒã‚­ãƒ£ã‚¹ãƒˆ (224.0.0.1:16520) â€” ã‚»ãƒ³ã‚µãƒ¼ãƒ‡ãƒ¼ã‚¿ã®ã¿
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ RPi (ArSprout RPi, 10.10.0.10, Raspbian Lite)            â”‚
â”‚                                                           â”‚
â”‚ [ã‚»ãƒ³ã‚µãƒ¼å…¥åŠ›]                                            â”‚
â”‚   ccm_receiver.py  â†’  MQTT: agriha/h01/ccm/...          â”‚
â”‚   sensor_loop.py   â†’  MQTT: agriha/h01/sensor/...       â”‚
â”‚                    â†’  MQTT: agriha/farm/weather/misol    â”‚
â”‚                                                           â”‚
â”‚ [ä¸‰å±¤åˆ¶å¾¡]                                                â”‚
â”‚   Layer 1: emergency_guard.sh (ifæ–‡+LINE curl)           â”‚
â”‚            27â„ƒè¶…/16â„ƒä»¥ä¸‹ã§å•ç­”ç„¡ç”¨ã€‚LLMä¸è¦              â”‚
â”‚   Layer 2: rule_engine (cron+æ—¥å°„æ¯”ä¾‹çŒæ°´+æ¸©åº¦é–¾å€¤å´çª“)  â”‚
â”‚            æ—¥å¸¸ã®95%ã€‚LLMä¸è¦                             â”‚
â”‚   Layer 3: agriha_control.py (cronæ¯æ™‚â†’Claude Haiku API) â”‚
â”‚            1æ™‚é–“äºˆå ±JSONç”Ÿæˆâ†’plan_executor.pyãŒå®Ÿè¡Œ       â”‚
â”‚                                                           â”‚
â”‚ [ã‚¢ã‚¯ãƒãƒ¥ã‚¨ãƒ¼ã‚¿å‡ºåŠ›]                                      â”‚
â”‚   REST API (:8080)                                       â”‚
â”‚     POST /api/relay/{ch} â†’ MQTT relay/{ch}/set           â”‚
â”‚   MqttRelayBridge â†’ MCP23008 I2C â†’ ãƒªãƒ¬ãƒ¼ ch1-8         â”‚
â”‚                                                           â”‚
â”‚ [å®‰å…¨æ©Ÿæ§‹]                                                â”‚
â”‚   CommandGate  â† gpio_watch (DIç·Šæ€¥ã‚¹ã‚¤ãƒƒãƒ)             â”‚
â”‚   ãƒ­ãƒƒã‚¯ã‚¢ã‚¦ãƒˆä¸­ã¯å…¨ãƒªãƒ¬ãƒ¼æ“ä½œã‚’æ‹’å¦ (423)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚  HTTPS (Anthropic API)
               â–¼
         Claude Haiku API
         â†’ tool_calls: get_sensors, get_status, set_relay
         â†’ 1æ™‚é–“ã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¨ˆç”»JSONè¿”å´

ãƒ•ã‚§ã‚¤ãƒ«ã‚»ãƒ¼ãƒ•: LLMåœæ­¢æ™‚ã¯Layer 2ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹+Layer 1ç·Šæ€¥åœæ­¢ã§ç¨¼åƒç¶™ç¶š
å®‰å…¨åˆ¶å¾¡: Layer 1 = ifæ–‡+curlï¼ˆLLMéä¾å­˜ï¼‰
          unipi-daemon CommandGateï¼ˆç·Šæ€¥ã‚¹ã‚¤ãƒƒãƒâ†’300ç§’ãƒ­ãƒƒã‚¯ã‚¢ã‚¦ãƒˆï¼‰

ãƒ‡ãƒ¼ã‚¿çµŒè·¯:
  CCM â†’ ccm_receiver â†’ MQTT â†’ REST API /api/sensors
  CCM â†’ ccm_receiver â†’ MQTT â†’ Telegraf â†’ InfluxDB â†’ Grafana
  Misol WH65LP â†’ sensor_loop â†’ MQTT (agriha/farm/weather/misol)
  DS18B20 â†’ sensor_loop â†’ MQTT (agriha/{house_id}/sensor/DS18B20)
```

> **v3.0å¤‰æ›´ç‚¹**: ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’ä¸‰å±¤æ§‹é€ ã«å…¨é¢è»¢æ›ã€‚
> LLMã¯ã€ŒçŸ¥æµã€å±¤ã¨ã—ã¦1æ™‚é–“äºˆå ±ã®ã¿æ‹…å½“ã€‚æ—¥å¸¸åˆ¶å¾¡ã®95%ã¯ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã€‚
> ç·Šæ€¥åœæ­¢ã¯LLMã‚’ä¸€åˆ‡ä»‹ã•ãªã„ifæ–‡+curlã®ç‹¬ç«‹ç³»çµ±ã€‚

---

## ç›®æ¬¡

1. [ä¸‰å±¤åˆ¶å¾¡ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](#1-ä¸‰å±¤åˆ¶å¾¡ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£)
2. [LLMã®è²¬å‹™ç¯„å›²](#2-llmã®è²¬å‹™ç¯„å›²)
3. [1æ™‚é–“äºˆå ±ï¼‹ç·Šæ€¥ãƒ•ãƒ©ã‚°æ–¹å¼](#3-1æ™‚é–“äºˆå ±ç·Šæ€¥ãƒ•ãƒ©ã‚°æ–¹å¼)
4. [Claude Haiku API æ¥ç€å±¤](#4-claude-haiku-api-æ¥ç€å±¤)
5. [ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­è¨ˆ](#5-ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­è¨ˆ)
6. [ã‚¹ãƒ†ãƒ¼ãƒˆç®¡ç†](#6-ã‚¹ãƒ†ãƒ¼ãƒˆç®¡ç†)
7. [LLMè‡ªç„¶æ¸›è¡°ãƒ¢ãƒ‡ãƒ«](#7-llmè‡ªç„¶æ¸›è¡°ãƒ¢ãƒ‡ãƒ«)
8. [å®‰å…¨åˆ¶å¾¡è¨­è¨ˆ](#8-å®‰å…¨åˆ¶å¾¡è¨­è¨ˆ)
9. [ã‚¢ã‚¯ãƒãƒ¥ã‚¨ãƒ¼ã‚¿åˆ¶å¾¡ï¼ˆUniPiãƒªãƒ¬ãƒ¼ï¼‰](#9-ã‚¢ã‚¯ãƒãƒ¥ã‚¨ãƒ¼ã‚¿åˆ¶å¾¡unipiãƒªãƒ¬ãƒ¼)
10. [ãƒªãƒ¬ãƒ¼ãƒãƒ£ãƒ³ãƒãƒ«å‰²å½“](#10-ãƒªãƒ¬ãƒ¼ãƒãƒ£ãƒ³ãƒãƒ«å‰²å½“)
11. [RPiã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †](#11-rpiã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †)
12. [å‚ç…§ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](#12-å‚ç…§ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ)
13. [ä»˜éŒ²A: v2.0â†’v3.0 å¤‰æ›´å±¥æ­´](#ä»˜éŒ²a-v20v30-å¤‰æ›´å±¥æ­´)

---

## 1. ä¸‰å±¤åˆ¶å¾¡ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### 1.1 è¨­è¨ˆæ€æƒ³

æ¸©å®¤åˆ¶å¾¡ã«ãŠã„ã¦æœ€ã‚‚é‡è¦ãªåŸå‰‡: **ä¸‹ä½å±¤ã¯ä¸Šä½å±¤ã®éšœå®³ã«å½±éŸ¿ã•ã‚Œãªã„**ã€‚

```
Layer 3: çŸ¥æµï¼ˆLLMï¼‰  â† æœ€ã‚‚é«˜åº¦ã€æœ€ã‚‚è„†ã„
Layer 2: ã‚¬ãƒ ãƒ†ï¼ˆãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ï¼‰  â† æ—¥å¸¸ã®95%
Layer 1: çˆ†ç™ºï¼ˆç·Šæ€¥åœæ­¢ï¼‰  â† çµ¶å¯¾ã«å£Šã‚Œãªã„
```

ãƒ–ãƒ¬ãƒ¼ã‚«ãƒ¼ã¨éå¸¸ãƒ™ãƒ«ã¯ã€æŒ‡å°å“¡ãŒãƒ‘ãƒ‹ã‚¯ã£ã¦ã‚‚å‹•ãã€‚
ç·Šæ€¥åœæ­¢ã¨LLMã¯**åˆ¥ç³»çµ±**ã€‚ã“ã‚ŒãŒæœ¬è¨­è¨ˆæ›¸ã®æ ¹å¹¹æ€æƒ³ã§ã‚ã‚‹ã€‚

### 1.2 Layer 1: çˆ†ç™ºï¼ˆç·Šæ€¥åœæ­¢ï¼‰

**LLMã‚‚ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã‚‚ä¸€åˆ‡é–¢ä¿‚ãªã„ã€‚ifæ–‡ã¨curlã ã‘ã§å‹•ãã€‚**

```bash
# emergency_guard.shï¼ˆæ¦‚å¿µã‚³ãƒ¼ãƒ‰ï¼‰
TEMP=$(curl -s http://localhost:8080/api/sensors | python3 -c "
import sys,json; print(json.load(sys.stdin)['ccm']['InAirTemp'])")

if (( $(echo "$TEMP > 27" | bc -l) )); then
    # å…¨çª“å…¨é–‹ï¼ˆch5-8 ONï¼‰
    for ch in 5 6 7 8; do
        curl -s -X POST "http://localhost:8080/api/relay/$ch" \
            -H 'Content-Type: application/json' \
            -d '{"value":1,"duration_sec":0,"reason":"EMERGENCY: overheat"}'
    done
    # LINEé€šçŸ¥ï¼ˆLLMã‚’é€šã•ãªã„ã€‚curlã§ç›´æ¥å©ãï¼‰
    curl -s -X POST "https://api.line.me/v2/bot/message/push" \
        -H "Authorization: Bearer $LINE_TOKEN" \
        -H 'Content-Type: application/json' \
        -d "{\"to\":\"$GROUP_ID\",\"messages\":[{\"type\":\"text\",\"text\":\"ğŸš¨ ${TEMP}â„ƒ ç·Šæ€¥å…¨é–‹\"}]}"
fi

if (( $(echo "$TEMP < 16" | bc -l) )); then
    # å…¨çª“å…¨é–‰ï¼ˆch5-8 OFFï¼‰
    for ch in 5 6 7 8; do
        curl -s -X POST "http://localhost:8080/api/relay/$ch" \
            -H 'Content-Type: application/json' \
            -d '{"value":0,"duration_sec":0,"reason":"EMERGENCY: freeze risk"}'
    done
    curl -s -X POST "https://api.line.me/v2/bot/message/push" \
        -H "Authorization: Bearer $LINE_TOKEN" \
        -H 'Content-Type: application/json' \
        -d "{\"to\":\"$GROUP_ID\",\"messages\":[{\"type\":\"text\",\"text\":\"ğŸš¨ ${TEMP}â„ƒ ç·Šæ€¥å…¨é–‰\"}]}"
fi
```

**ç‹¬ç«‹å‹•ä½œä¿è¨¼**:
- LLMï¼ˆLayer 3ï¼‰ãŒå®Œå…¨åœæ­¢ã—ã¦ã‚‚ã€Layer 1ã¯å‹•ä½œã™ã‚‹
- ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ï¼ˆLayer 2ï¼‰ãŒåœæ­¢ã—ã¦ã‚‚ã€Layer 1ã¯å‹•ä½œã™ã‚‹
- Starlinkå›ç·šãŒæ–­çµ¶ã—ã¦ã‚‚ã€RPiãƒ­ãƒ¼ã‚«ãƒ«ã§å‹•ä½œã™ã‚‹ï¼ˆLINEé€šçŸ¥ã®ã¿ä¸é”ï¼‰
- croné–“éš”: `*/1`ï¼ˆ1åˆ†æ¯ï¼‰ã€‚LLMã®1æ™‚é–“é–“éš”ã‚’å¾…ãŸãªã„

### 1.3 Layer 2: ã‚¬ãƒ ãƒ†ï¼ˆãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ï¼‰

**æ—¥å¸¸ã®95%ã‚’æ‹…å½“ã€‚LLMãªã—ã§ã‚‚å›ã‚‹ã€‚**

```
åˆ¶å¾¡å¯¾è±¡ã¨æ–¹å¼:
  çŒæ°´     = ã‚¿ã‚¤ãƒãƒ¼ + æ—¥å°„æ¯”ä¾‹ã€‚cron + crop_irrigation.yaml ã®é–¾å€¤
  å´çª“     = æ¸©åº¦é–¾å€¤ã€‚æ°—æ¸©>ç›®æ¨™+2â„ƒã§é–‹ã€æ°—æ¸©<ç›®æ¨™-1â„ƒã§é–‰
  EC       = ãƒ‰ã‚µãƒˆãƒ­ãƒ³æ‰‹å‹•èª¿æ•´ã€‚åˆ¶å¾¡å¯¾è±¡å¤–
  æ›æ°—æ‰‡   = æ¸©åº¦é€£å‹•ON/OFFï¼ˆé–¾å€¤ãƒ™ãƒ¼ã‚¹ï¼‰

é‡ã¿è£œæ­£:
  crop_irrigation.yaml ã®ã‚¹ãƒ†ãƒ¼ã‚¸åˆ¥ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§çŒæ°´é‡ãƒ»æ¸©åº¦ç›®æ¨™ã‚’èª¿æ•´
  å°†æ¥çš„ã«LLMè‡ªç„¶æ¸›è¡°ãƒ¢ãƒ‡ãƒ«ï¼ˆÂ§7ï¼‰ã§LLMåˆ¤æ–­ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒ«ãƒ¼ãƒ«ã«è’¸ç•™
```

**ç‹¬ç«‹å‹•ä½œä¿è¨¼**:
- LLMï¼ˆLayer 3ï¼‰ãŒåœæ­¢ã—ã¦ã‚‚ã€æ—¥å°„æ¯”ä¾‹çŒæ°´ã¨æ¸©åº¦é–¾å€¤åˆ¶å¾¡ã¯ç¶™ç¶š
- RPiä¸Šã®cronã¨Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ã¿ã§å‹•ä½œï¼ˆå¤–éƒ¨APIä¸è¦ï¼‰

### 1.4 Layer 3: çŸ¥æµï¼ˆLLMï¼‰

**ãŸã¾ã«ç›¸è«‡ã™ã‚‹çŸ¥æµè¢‹ã€‚system_prompt.txt ãŒæœ¬ä½“ã€‚**

CO2ã¨éœ²ç‚¹ã®åˆ¤æ–­ã ã‘ãŒLLMã®ä»•äº‹ã€‚è©³ç´°ã¯Â§2ï¼ˆLLMã®è²¬å‹™ç¯„å›²ï¼‰å‚ç…§ã€‚

- cron æ¯æ™‚ï¼ˆ`0 * * * *`ï¼‰ã«Claude Haiku APIã‚’å‘¼ã³å‡ºã—
- å‘ã“ã†1æ™‚é–“ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¨ˆç”»JSONã‚’ç”Ÿæˆ
- RPiä¸Šã®plan_executor.pyãŒè¨ˆç”»é€šã‚Šã«å®Ÿè¡Œ
- é€šå¸¸24å›/æ—¥ + ç·Šæ€¥å‰²ã‚Šè¾¼ã¿æ•°å›
- æœˆã‚³ã‚¹ãƒˆ: æ•°ç™¾å††ç¨‹åº¦

**ç‹¬ç«‹å‹•ä½œä¿è¨¼**:
- Layer 3ãŒåœæ­¢ã—ã¦ã‚‚Layer 1+2ã§å®‰å…¨ã«ç¨¼åƒ
- Anthropic APIéšœå®³æ™‚ã¯Layer 2ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
- system_prompt.txtãŒæ–¹é‡ã®æ­£ãƒ‡ãƒ¼ã‚¿æºã€‚ã‚³ãƒ¼ãƒ‰å¤‰æ›´ãªã—ã§åˆ¶å¾¡æ–¹é‡ã‚’æ›´æ–°å¯èƒ½

---

## 2. LLMã®è²¬å‹™ç¯„å›²

### 2.1 LLMãŒåˆ¤æ–­ã™ã‚‹å ´é¢: CO2ã¨éœ²ç‚¹ã®2ã¤ã ã‘

LLMã®çœŸã®ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«åˆ¤æ–­ã¯**2å ´é¢ã®ã¿**ã€‚

| åˆ¤æ–­å ´é¢ | ãªãœLLMãŒå¿…è¦ã‹ | åˆ¤æ–­è¦ç´  |
|----------|----------------|----------|
| **CO2åˆ¶å¾¡** | æ›æ°—ã¨ã®ç›¸åï¼ˆå´çª“é–‹â†’CO2é€ƒã’ã‚‹ï¼‰ã€‚å˜ç´”é–¾å€¤ã§ã¯åˆ¤æ–­ä¸å¯ | æ°—æ¸©ãƒ»æ¹¿åº¦ãƒ»æ—¥å°„ãƒ»é¢¨é€Ÿãƒ»CO2æ¿ƒåº¦ã®ç·åˆåˆ¤æ–­ |
| **éœ²ç‚¹åˆ¶å¾¡** | çµéœ²=ç—…æ°—ã€‚æš–æˆ¿ã‹æ›æ°—ã‹ã®äºŒæŠã‚’çŠ¶æ³åˆ¤æ–­ | å†…æ°—æ¸©ãƒ»å¤–æ°—æ¸©ãƒ»æ¹¿åº¦ãƒ»æ™‚é–“å¸¯ãƒ»å¤©å€™ |

### 2.2 LLMä¸è¦ãªåˆ¶å¾¡

| åˆ¶å¾¡å¯¾è±¡ | æ–¹å¼ | LLMã®é–¢ä¸ |
|----------|------|-----------|
| çŒæ°´ | ã‚¿ã‚¤ãƒãƒ¼ + æ—¥å°„æ¯”ä¾‹ï¼ˆcrop_irrigation.yamlï¼‰ | ãªã—ï¼ˆLayer 2ï¼‰ |
| å´çª“ | æ¸©åº¦é–¾å€¤ï¼ˆç›®æ¨™æ¸©åº¦Â±Î”Tï¼‰ | ãªã—ï¼ˆLayer 2ï¼‰â€»CO2/éœ²ç‚¹åˆ¤æ–­æ™‚ã®ã¿ä»‹å…¥ |
| EC | ãƒ‰ã‚µãƒˆãƒ­ãƒ³æ‰‹å‹•èª¿æ•´ | ãªã—ï¼ˆåˆ¶å¾¡å¯¾è±¡å¤–ï¼‰ |
| ç·Šæ€¥åœæ­¢ | ifæ–‡ + LINE curlï¼ˆ27â„ƒè¶…/16â„ƒä»¥ä¸‹ï¼‰ | ãªã—ï¼ˆLayer 1ï¼‰ |

### 2.3 1æ—¥ã®å‘¼ã³å‡ºã—å›æ•°ã¨é »åº¦

```
å®šæ™‚äºˆå ±:   24å›/æ—¥ï¼ˆ1æ™‚é–“æ¯ï¼‰
ç·Šæ€¥å‰²è¾¼ã¿: æ•°å›/æ—¥ï¼ˆé–¾å€¤è¶…éæ™‚ã€LLMã‚’å¾…ãŸãšã«Layer 1ãŒå…ˆè¡Œå‹•ä½œï¼‰
åˆè¨ˆ:       ~30å›/æ—¥ä»¥ä¸‹

1å›ã®APIå‘¼ã³å‡ºã—:
  å…¥åŠ›: ~2,000ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ+å±¥æ­´+ã‚»ãƒ³ã‚µãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼‰
  å‡ºåŠ›: ~300ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¨ˆç”»JSON+åˆ¤æ–­ç†ç”±ï¼‰
  ã‚³ã‚¹ãƒˆ: Claude Haiku 1å›ã‚ãŸã‚Š ~$0.001æœªæº€

æœˆé–“ã‚³ã‚¹ãƒˆ: ~30å›/æ—¥ Ã— 30æ—¥ Ã— $0.001 â‰ˆ $1æœªæº€ï¼ˆæ•°ç™¾å††ç¨‹åº¦ï¼‰
```

---

## 3. 1æ™‚é–“äºˆå ±ï¼‹ç·Šæ€¥ãƒ•ãƒ©ã‚°æ–¹å¼

### 3.1 æ¦‚è¦

```
å®šæ™‚äºˆå ±ï¼ˆcron æ¯æ™‚ï¼‰                    ç·Šæ€¥å‰²ã‚Šè¾¼ã¿ï¼ˆcron æ¯åˆ†ï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ agriha_control.py    â”‚           â”‚ emergency_guard.sh      â”‚
â”‚ Claude Haiku API     â”‚           â”‚ ifæ–‡ + curl             â”‚
â”‚ â†’ 1æ™‚é–“è¨ˆç”»JSON      â”‚           â”‚ LLMã‚’å¾…ãŸãªã„           â”‚
â”‚ â†’ plan_executor.py   â”‚           â”‚ 27â„ƒè¶…/16â„ƒä»¥ä¸‹ã§å³å‹•ä½œ  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†“ é€šå¸¸åˆ¶å¾¡                          â†“ ç·Šæ€¥åˆ¶å¾¡ï¼ˆæœ€å„ªå…ˆï¼‰
      â–¼                                   â–¼
  unipi-daemon REST API â†’ MCP23008 I2C â†’ ãƒªãƒ¬ãƒ¼ ch1-8
```

### 3.2 å®šæ™‚äºˆå ±ãƒ«ãƒ¼ãƒ—ã®æµã‚Œ

```
cron (0 * * * *) â†’ agriha_control.py èµ·å‹•
    â”‚
    â”œâ”€ Step 1: unipi-daemon REST API ã¸ã®æ¥ç¶šç¢ºèª
    â”‚
    â”œâ”€ Step 2: ç›´è¿‘ã®åˆ¤æ–­å±¥æ­´ã‚’SQLiteã‹ã‚‰èª­ã¿è¾¼ã¿ï¼ˆÂ§6å‚ç…§ï¼‰
    â”‚
    â”œâ”€ Step 3: ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ + å±¥æ­´ + æŒ‡ç¤ºã‚’çµ„ã¿ç«‹ã¦
    â”‚          ã€Œç¾åœ¨ã®ã‚»ãƒ³ã‚µãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªã—ã€å‘ã“ã†1æ™‚é–“ã®
    â”‚           ã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¨ˆç”»ã‚’ JSON ã§ç”Ÿæˆã›ã‚ˆã€
    â”‚
    â”œâ”€ Step 4: Claude Haiku API ã«é€ä¿¡ï¼ˆtoolsé…åˆ—ä»˜ãï¼‰
    â”‚          â†’ LLMãŒè‡ªç™ºçš„ã«ãƒ„ãƒ¼ãƒ«ã‚’å‘¼ã¶:
    â”‚            (1) get_sensors  â†’ REST API GET /api/sensors
    â”‚                â†’ CCM(å†…æ¸©/æ¹¿åº¦/CO2) + DS18B20 + Misol(å¤–æ°—/é¢¨/é™é›¨)
    â”‚            (2) get_status   â†’ REST API GET /api/status
    â”‚                â†’ ãƒªãƒ¬ãƒ¼çŠ¶æ…‹(ch1-8) + ãƒ­ãƒƒã‚¯ã‚¢ã‚¦ãƒˆçŠ¶æ…‹
    â”‚            (3) åˆ¤æ–­ â†’ 1æ™‚é–“ã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¨ˆç”»JSONç”Ÿæˆ
    â”‚                â†’ å¿…è¦ã«å¿œã˜ã¦å³æ™‚set_relayå®Ÿè¡Œã‚‚
    â”‚
    â”œâ”€ Step 5: ã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¨ˆç”»JSONã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
    â”‚          /var/lib/agriha/current_plan.json
    â”‚
    â”œâ”€ Step 6: LLMã®æœ€çµ‚å¿œç­”ï¼ˆåˆ¤æ–­ç†ç”±ï¼‰ã‚’ãƒ­ã‚°ã«è¨˜éŒ²
    â”‚
    â””â”€ Step 7: ãƒ—ãƒ­ã‚»ã‚¹çµ‚äº†ï¼ˆæ¬¡ã®cronèµ·å‹•ã¾ã§å¾…æ©Ÿï¼‰
```

### 3.3 ã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¨ˆç”»JSON

LLMãŒç”Ÿæˆã™ã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¨ˆç”»ã®å½¢å¼:

```json
{
  "generated_at": "2026-02-28T14:00:00+09:00",
  "valid_until": "2026-02-28T15:00:00+09:00",
  "summary": "æ—¥å°„å¼·ãæ°—æ¸©ä¸Šæ˜‡å‚¾å‘ã€‚CO2ã¯æ›æ°—ã§è‡ªç„¶å€¤ã€‚éœ²ç‚¹ãƒªã‚¹ã‚¯ãªã—ã€‚",
  "actions": [
    {
      "execute_at": "+0min",
      "relay_ch": 5,
      "value": 1,
      "duration_sec": 30,
      "reason": "åŒ—å´çª“50%é–‹ï¼ˆæ°—æ¸©ä¸Šæ˜‡å¯¾å¿œï¼‰"
    },
    {
      "execute_at": "+30min",
      "relay_ch": 4,
      "value": 1,
      "duration_sec": 300,
      "reason": "çŒæ°´5åˆ†ï¼ˆæ—¥å°„æ¯”ä¾‹é–¾å€¤åˆ°é”è¦‹è¾¼ã¿ï¼‰"
    }
  ],
  "co2_advisory": "æ›æ°—ä¸­ã®ãŸã‚CO2è‡ªç„¶å€¤ã§æ¨ç§»ã€‚å¯†é–‰åˆ¤æ–­ä¸è¦",
  "dewpoint_risk": "low",
  "next_check_note": "15æ™‚ã«æ—¥å°„æ¸›è¡°è¦‹è¾¼ã¿ã€‚å´çª“èª¿æ•´ã®å¯èƒ½æ€§ã‚ã‚Š"
}
```

### 3.4 ç·Šæ€¥å‰²ã‚Šè¾¼ã¿

LLMã®1æ™‚é–“äºˆå ±ã‚’å¾…ãŸãšã€Layer 1ãŒå³åº§ã«å‹•ä½œã™ã‚‹å ´é¢:

| æ¡ä»¶ | å‹•ä½œ | LLMã®é–¢ä¸ |
|------|------|-----------|
| å†…æ°—æ¸© > 27â„ƒ | å…¨çª“å…¨é–‹ + LINEé€šçŸ¥ | **ãªã—** |
| å†…æ°—æ¸© < 16â„ƒ | å…¨çª“å…¨é–‰ + LINEé€šçŸ¥ | **ãªã—** |
| é™é›¨æ¤œçŸ¥ (rainfall > 0.5mm/h) | çª“ç³»ãƒªãƒ¬ãƒ¼å…¨OFF | **ãªã—** |
| ç·Šæ€¥ã‚¹ã‚¤ãƒƒãƒæŠ¼ä¸‹ | CommandGate 300ç§’ãƒ­ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ | **ãªã—** |

> **é‡è¦**: ç·Šæ€¥å‰²ã‚Šè¾¼ã¿ãŒç™ºå‹•ã—ãŸå ´åˆã§ã‚‚ã€æ¬¡å›ã®å®šæ™‚äºˆå ±ï¼ˆæ¯æ™‚cronï¼‰ã§
> LLMã¯ç¾åœ¨ã®çŠ¶æ…‹ã‚’ get_status ã§ç¢ºèªã—ã€ç·Šæ€¥å‰²ã‚Šè¾¼ã¿å¾Œã®çŠ¶æ…‹ã‚’è€ƒæ…®ã—ãŸ
> æ–°ãŸãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¨ˆç”»ã‚’ç”Ÿæˆã™ã‚‹ã€‚

### 3.5 ã‚³ã‚¹ãƒˆè¦‹ç©ã‚‚ã‚Š

| é …ç›® | æ•°é‡ | å˜ä¾¡ | æœˆé¡ |
|------|------|------|------|
| å®šæ™‚äºˆå ± | 24å›/æ—¥ Ã— 30æ—¥ = 720å› | ~$0.001/å› | ~$0.72 |
| ç·Šæ€¥å‰²ã‚Šè¾¼ã¿ | LLMã‚’å‘¼ã°ãªã„ | $0 | $0 |
| **åˆè¨ˆ** | | | **~$1/æœˆï¼ˆæ•°ç™¾å††ï¼‰** |

> v2.0ï¼ˆcron 10åˆ†é–“éš”ï¼‰ã§ã¯æœˆç´„$9ã ã£ãŸãŒã€1æ™‚é–“äºˆå ±æ–¹å¼ã§å¤§å¹…ã«å‰Šæ¸›ã€‚

---

## 4. Claude Haiku API æ¥ç€å±¤

### 4.1 æ–¹å¼é¸å®š

| æ–¹å¼ | ä¾å­˜ | ã‚³ã‚¹ãƒˆ | è©•ä¾¡ |
|------|------|--------|------|
| **(æ¡ç”¨) Claude Haiku API + anthropic SDK** | `anthropic`, `httpx` | æœˆ~$1 | **2026-02-23æ®¿è£å®š** |
| LFM2.5 (llama-server) | `httpx` | é›»åŠ›ã®ã¿ | **å»ƒæ­¢**: å¯¾è©±èƒ½åŠ›è‡´å‘½çš„ä¸è¶³ |
| Ollama (ãƒ­ãƒ¼ã‚«ãƒ«LLM) | `ollama` | é›»åŠ›ã®ã¿ | **åœæ­¢æ¸ˆã¿**: ã‚·ãƒ£ãƒ‰ãƒ¼ãƒ¢ãƒ¼ãƒ‰2026-02-24æ®¿åˆ¤æ–­ã§åœæ­¢ã€‚vx2ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯å°‚ç”¨ |

**å»ƒæ­¢ç†ç”±ï¼ˆLFM2.5ï¼‰**:
- æ—¥æ™‚èª­å–ä¸å¯ã€tool_callsè‡ªç™ºç”Ÿæˆä¸å¯
- æ®¿æ›°ãã€Œè‡ªåˆ†ã®äººä»¶è²»ã‚ˆã‚Šã¯å®‰ã„ã€ï¼ˆClaude Haikuæœˆ~$1ï¼‰
- å°†æ¥ãƒ­ãƒ¼ã‚«ãƒ«LLMãŒå®Ÿç”¨ã«è€ãˆã‚Œã°å†æ¤œè¨ï¼ˆÂ§7 LLMè‡ªç„¶æ¸›è¡°ãƒ¢ãƒ‡ãƒ«å‚ç…§ï¼‰

> **v3.0å¤‰æ›´**: llama-server (localhost:8081) ã‚’å…¨é¢å»ƒæ­¢ã€‚
> RPiã‹ã‚‰Anthropic APIã«ç›´æ¥HTTPSé€šä¿¡ã€‚ä¸­é–“å±¤ï¼ˆnipogiç­‰ï¼‰ä¸è¦ã€‚

### 4.2 Anthropic tool calling

Claude Haiku APIã¯ `tools` é…åˆ—ã‚’å—ã‘å–ã‚Šã€LLMãŒè‡ªç™ºçš„ã«tool_useã‚’ç”Ÿæˆã™ã‚‹ã€‚

```python
import anthropic

client = anthropic.Anthropic()  # ANTHROPIC_API_KEY ç’°å¢ƒå¤‰æ•°

response = client.messages.create(
    model="claude-haiku-4-5-20251001",
    max_tokens=1024,
    system=system_prompt,
    tools=[
        {
            "name": "get_sensors",
            "description": "å…¨ã‚»ãƒ³ã‚µãƒ¼ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆCCMå†…æ°—è±¡ + DS18B20 + Misolå¤–æ°—è±¡ï¼‰",
            "input_schema": {"type": "object", "properties": {}},
        },
        {
            "name": "get_status",
            "description": "ãƒ‡ãƒ¼ãƒ¢ãƒ³çŠ¶æ…‹å–å¾—ï¼ˆãƒªãƒ¬ãƒ¼çŠ¶æ…‹ch1-8 + ãƒ­ãƒƒã‚¯ã‚¢ã‚¦ãƒˆçŠ¶æ…‹ï¼‰",
            "input_schema": {"type": "object", "properties": {}},
        },
        {
            "name": "set_relay",
            "description": (
                "UniPiãƒªãƒ¬ãƒ¼åˆ¶å¾¡ã€‚ch=ãƒãƒ£ãƒ³ãƒãƒ«(1-8), value=1(ON)/0(OFF), "
                "duration_sec=è‡ªå‹•OFFç§’æ•°(çŒæ°´ç­‰ã¯å¿…é ˆæŒ‡å®š), reason=ç†ç”±"
            ),
            "input_schema": {
                "type": "object",
                "properties": {
                    "ch": {"type": "integer", "minimum": 1, "maximum": 8},
                    "value": {"type": "integer", "enum": [0, 1]},
                    "duration_sec": {"type": "number", "default": 0},
                    "reason": {"type": "string", "default": ""},
                },
                "required": ["ch", "value"],
            },
        },
    ],
    messages=messages,
)
```

### 4.3 æ¥ç€å±¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆ: agriha_control.py

```python
#!/usr/bin/env python3
"""AgriHA LLMåˆ¶å¾¡ãƒ«ãƒ¼ãƒ— â€” Claude Haiku API + unipi-daemon REST API
1æ™‚é–“äºˆå ±æ–¹å¼: æ¯æ™‚cronã§èµ·å‹•ã€å‘ã“ã†1æ™‚é–“ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¨ˆç”»ã‚’ç”Ÿæˆ"""

import json
import logging
import sqlite3
from datetime import datetime, timezone
from pathlib import Path

import anthropic
import httpx
from astral import LocationInfo
from astral.sun import sun

# è¨­å®š
# astral: æ—¥ã®å‡º/æ—¥æ²¡è¨ˆç®—ï¼ˆLLMã¯è‡ªåŠ›ã§æ—¥æ™‚æŠŠæ¡ä¸å¯â†’å…¨çµŒè·¯ã«æ³¨å…¥ï¼‰
LOCATION = LocationInfo("Greenhouse", "Japan", "Asia/Tokyo", 42.888, 141.603)  # é“å¤®åœƒå ´
UNIPI_API = "http://localhost:8080"  # unipi-daemon REST APIï¼ˆRPiãƒ­ãƒ¼ã‚«ãƒ«ï¼‰
API_KEY = ""  # config.yaml ã® rest_api.api_key ã«åˆã‚ã›ã‚‹
DB_PATH = Path("/var/lib/agriha/control_log.db")
SYSTEM_PROMPT_PATH = Path("/etc/agriha/system_prompt.txt")
PLAN_PATH = Path("/var/lib/agriha/current_plan.json")
MAX_TOOL_ROUNDS = 5  # ãƒ„ãƒ¼ãƒ«å‘¼ã³å‡ºã—æœ€å¤§ãƒ©ã‚¦ãƒ³ãƒ‰æ•°
MODEL = "claude-haiku-4-5-20251001"

logger = logging.getLogger("agriha_control")

# ãƒ„ãƒ¼ãƒ«å®šç¾©ï¼ˆAnthropic toolså½¢å¼ï¼‰
TOOLS = [
    {
        "name": "get_sensors",
        "description": "å…¨ã‚»ãƒ³ã‚µãƒ¼ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆCCMå†…æ°—è±¡ + DS18B20 + Misolå¤–æ°—è±¡ï¼‰",
        "input_schema": {"type": "object", "properties": {}},
    },
    {
        "name": "get_status",
        "description": "ãƒ‡ãƒ¼ãƒ¢ãƒ³çŠ¶æ…‹å–å¾—ï¼ˆãƒªãƒ¬ãƒ¼çŠ¶æ…‹ch1-8 + ãƒ­ãƒƒã‚¯ã‚¢ã‚¦ãƒˆçŠ¶æ…‹ï¼‰",
        "input_schema": {"type": "object", "properties": {}},
    },
    {
        "name": "set_relay",
        "description": (
            "UniPiãƒªãƒ¬ãƒ¼åˆ¶å¾¡ã€‚ch=ãƒãƒ£ãƒ³ãƒãƒ«(1-8), value=1(ON)/0(OFF), "
            "duration_sec=è‡ªå‹•OFFç§’æ•°(çŒæ°´ç­‰ã¯å¿…é ˆæŒ‡å®š), reason=ç†ç”±"
        ),
        "input_schema": {
            "type": "object",
            "properties": {
                "ch": {"type": "integer", "minimum": 1, "maximum": 8},
                "value": {"type": "integer", "enum": [0, 1]},
                "duration_sec": {"type": "number", "default": 0},
                "reason": {"type": "string", "default": ""},
            },
            "required": ["ch", "value"],
        },
    },
]


def load_recent_history(db: sqlite3.Connection, n: int = 3) -> str:
    """ç›´è¿‘nå›ã®åˆ¤æ–­å±¥æ­´ã‚’ãƒ†ã‚­ã‚¹ãƒˆã§è¿”ã™"""
    rows = db.execute(
        "SELECT timestamp, summary, actions_taken "
        "FROM decisions ORDER BY id DESC LIMIT ?", (n,)
    ).fetchall()
    if not rows:
        return "ï¼ˆéå»ã®åˆ¤æ–­å±¥æ­´ãªã— â€” åˆå›èµ·å‹•ï¼‰"
    lines = []
    for ts, summary, actions in reversed(rows):
        lines.append(f"[{ts}] {summary} â†’ {actions}")
    return "\n".join(lines)


def save_decision(db: sqlite3.Connection, summary: str, actions: str,
                  raw_response: str, sensor_snapshot: str):
    """åˆ¤æ–­ãƒ­ã‚°ã‚’SQLiteã«ä¿å­˜"""
    db.execute(
        "INSERT INTO decisions (timestamp, summary, actions_taken, "
        "raw_response, sensor_snapshot) VALUES (?, ?, ?, ?, ?)",
        (datetime.now(timezone.utc).isoformat(), summary, actions,
         raw_response, sensor_snapshot)
    )
    db.commit()


def call_tool(client: httpx.Client, name: str, args: dict) -> str:
    """ãƒ„ãƒ¼ãƒ«åã«å¿œã˜ã¦unipi-daemon REST APIã‚’å‘¼ã¶"""
    headers = {"X-API-Key": API_KEY} if API_KEY else {}

    if name == "get_sensors":
        r = client.get(f"{UNIPI_API}/api/sensors", headers=headers)
        return r.text

    if name == "get_status":
        r = client.get(f"{UNIPI_API}/api/status", headers=headers)
        return r.text

    if name == "set_relay":
        ch = args.get("ch", 1)
        payload = {
            "value": args.get("value", 0),
            "duration_sec": args.get("duration_sec", 0),
            "reason": args.get("reason", "LLM auto"),
        }
        r = client.post(
            f"{UNIPI_API}/api/relay/{ch}",
            json=payload,
            headers=headers,
        )
        return r.text

    return json.dumps({"error": f"unknown tool: {name}"})


def run_control_loop():
    """ãƒ¡ã‚¤ãƒ³åˆ¶å¾¡ãƒ«ãƒ¼ãƒ—ï¼ˆ1å›å®Ÿè¡Œã€æ¯æ™‚cronã‹ã‚‰å‘¼ã°ã‚Œã‚‹ï¼‰"""

    # DBæ¥ç¶š
    db = sqlite3.connect(DB_PATH)
    db.execute("""CREATE TABLE IF NOT EXISTS decisions (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        timestamp TEXT NOT NULL,
        summary TEXT,
        actions_taken TEXT,
        raw_response TEXT,
        sensor_snapshot TEXT
    )""")

    # ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆèª­ã¿è¾¼ã¿
    system_prompt = SYSTEM_PROMPT_PATH.read_text(encoding="utf-8")

    # ç›´è¿‘ã®åˆ¤æ–­å±¥æ­´
    history = load_recent_history(db, n=3)

    # Anthropic ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ + unipi-daemon HTTPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    llm_client = anthropic.Anthropic()
    api_client = httpx.Client(timeout=30)

    try:
        # astral: æ—¥ã®å‡º/æ—¥æ²¡è¨ˆç®— â†’ æ™‚é–“å¸¯4åŒºåˆ†ã‚’æ³¨å…¥
        now = datetime.now()
        s = sun(LOCATION.observer, date=now.date())
        sunrise = s["sunrise"].strftime("%H:%M")
        sunset = s["sunset"].strftime("%H:%M")
        hour = now.hour
        sunrise_h = s["sunrise"].hour
        sunset_h = s["sunset"].hour
        if hour < sunrise_h:
            time_period = "æ—¥ã®å‡ºå‰ï¼ˆå¤œé–“ï¼‰"
        elif hour >= sunset_h:
            time_period = "æ—¥æ²¡å¾Œï¼ˆå¤œé–“ï¼‰"
        elif hour >= sunset_h - 1:
            time_period = "æ—¥æ²¡å‰1hï¼ˆå¤•æ–¹é®å…‰æ³¨æ„ï¼‰"
        else:
            time_period = "æ—¥ä¸­"

        # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸çµ„ã¿ç«‹ã¦ï¼ˆ1æ™‚é–“äºˆå ±æŒ‡ç¤ºï¼‰
        messages = [
            {"role": "user", "content": (
                f"## ç›´è¿‘ã®åˆ¤æ–­å±¥æ­´\n{history}\n\n"
                f"## æŒ‡ç¤º\n"
                f"ç¾åœ¨æ™‚åˆ»: {now.strftime('%Y-%m-%d %H:%M')}\n"
                f"æ—¥ã®å‡º: {sunrise} / æ—¥æ²¡: {sunset} / æ™‚é–“å¸¯: {time_period}\n"
                f"ã‚»ãƒ³ã‚µãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªã—ã€å‘ã“ã†1æ™‚é–“ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¨ˆç”»ã‚’"
                f"JSONå½¢å¼ã§ç”Ÿæˆã›ã‚ˆã€‚\n"
                f"CO2åˆ¶å¾¡ã¨éœ²ç‚¹ãƒªã‚¹ã‚¯ã«ç‰¹ã«æ³¨æ„ã›ã‚ˆã€‚\n"
                f"ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒä¸è¦ãªã‚‰ã€Œç¾çŠ¶ç¶­æŒã€ã¨å ±å‘Šã›ã‚ˆã€‚"
            )},
        ]

        # Tool calling ãƒ«ãƒ¼ãƒ—
        sensor_snapshot = ""
        actions_taken = []

        for round_num in range(MAX_TOOL_ROUNDS):
            response = llm_client.messages.create(
                model=MODEL,
                max_tokens=1024,
                system=system_prompt,
                tools=TOOLS,
                messages=messages,
            )

            # ãƒ¬ã‚¹ãƒãƒ³ã‚¹è§£æ
            tool_uses = [b for b in response.content if b.type == "tool_use"]
            text_blocks = [b for b in response.content if b.type == "text"]

            if not tool_uses:
                # ãƒ„ãƒ¼ãƒ«å‘¼ã³å‡ºã—ãªã— â†’ æœ€çµ‚å¿œç­”
                break

            # assistantãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
            messages.append({"role": "assistant", "content": response.content})

            # å„ãƒ„ãƒ¼ãƒ«å‘¼ã³å‡ºã—ã‚’å®Ÿè¡Œ
            tool_results = []
            for tu in tool_uses:
                logger.info("Tool call [%d]: %s(%s)", round_num, tu.name, tu.input)

                result_text = call_tool(api_client, tu.name, tu.input)

                if tu.name in ("get_sensors", "get_status"):
                    sensor_snapshot += f"\n--- {tu.name} ---\n{result_text}"
                if tu.name == "set_relay":
                    actions_taken.append(
                        f"relay ch{tu.input.get('ch')}={tu.input.get('value')}"
                    )

                tool_results.append({
                    "type": "tool_result",
                    "tool_use_id": tu.id,
                    "content": result_text,
                })

            messages.append({"role": "user", "content": tool_results})

        # æœ€çµ‚å¿œç­”ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—
        final_text = ""
        for block in response.content:
            if hasattr(block, "text"):
                final_text += block.text
        if not final_text:
            final_text = "ï¼ˆå¿œç­”ãªã—ï¼‰"

        # ã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¨ˆç”»JSONã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ï¼ˆplan_executorç”¨ï¼‰
        try:
            # LLMã®å¿œç­”ã‹ã‚‰JSONãƒ–ãƒ­ãƒƒã‚¯ã‚’æŠ½å‡ºã—ã¦ä¿å­˜
            PLAN_PATH.write_text(final_text, encoding="utf-8")
        except Exception as e:
            logger.warning("Plan file save failed: %s", e)

        # åˆ¤æ–­ãƒ­ã‚°ä¿å­˜
        save_decision(
            db,
            summary=final_text[:500],
            actions="; ".join(actions_taken) if actions_taken else "ç¾çŠ¶ç¶­æŒ",
            raw_response=json.dumps({"text": final_text}, ensure_ascii=False),
            sensor_snapshot=sensor_snapshot[:2000],
        )

        logger.info("Decision: %s | Actions: %s", final_text[:200], actions_taken)

    finally:
        api_client.close()
        db.close()


if __name__ == "__main__":
    logging.basicConfig(level=logging.INFO,
                        format="%(asctime)s %(name)s %(levelname)s %(message)s")
    run_control_loop()
```

### 4.4 æ¥ç¶šãƒ¢ãƒ¼ãƒ‰

| ãƒ¢ãƒ¼ãƒ‰ | ä»•çµ„ã¿ | ç”¨é€” |
|--------|--------|------|
| **RPiãƒ­ãƒ¼ã‚«ãƒ«** | RPiä¸Šã§agriha_control.pyãŒå‹•ä½œã€localhost:8080ã§unipi-daemon REST APIã«æ¥ç¶š | **æ¨™æº–æ§‹æˆ** |
| **VPNçµŒç”±** | WireGuard VPNè¶Šã—ã«RPiä¸Šã®REST APIã«ãƒªãƒ¢ãƒ¼ãƒˆã‚¢ã‚¯ã‚»ã‚¹ | é éš”ãƒ‡ãƒãƒƒã‚° |

> **v3.0å¤‰æ›´**: RPiã‹ã‚‰Anthropic APIã«ç›´æ¥HTTPSé€šä¿¡ã€‚
> ä¸­é–“å±¤ï¼ˆnipogi, nuc.localç­‰ï¼‰ã¯ä¸è¦ã€‚Starlinkå›ç·šã§ç›´çµã€‚

---

## 5. ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­è¨ˆ

### 5.1 æ§‹é€ 

```
/etc/agriha/system_prompt.txt
  â”‚
  â”œâ”€ [A] å½¹å‰²å®šç¾©ï¼ˆå›ºå®šï¼‰
  â”œâ”€ [B] ãƒã‚¦ã‚¹å›ºæœ‰æƒ…å ±ï¼ˆè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ç”Ÿæˆï¼‰
  â”œâ”€ [C] ä½œç‰©ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆcrop_irrigation.yamlã‹ã‚‰ç”Ÿæˆï¼‰
  â”œâ”€ [D] åˆ¶å¾¡ãƒ«ãƒ¼ãƒ«ï¼ˆArSproutãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã‹ã‚‰æŠ½å‡ºï¼‰
  â”œâ”€ [E] æš—é»™çŸ¥ï¼ˆè¾²å®¶ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯+æ€’ã‚Šé§†å‹•ã§è“„ç©ï¼‰
  â”œâ”€ [F] å®‰å…¨åˆ¶ç´„ï¼ˆçµ¶å¯¾éµå®ˆï¼‰
  â””â”€ [G] å‡ºåŠ›å½¢å¼ï¼ˆ1æ™‚é–“ã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¨ˆç”»JSONï¼‰
```

> **v3.0å¤‰æ›´**: [G]ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã€‚LLMã«1æ™‚é–“ã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¨ˆç”»JSONã®å‡ºåŠ›å½¢å¼ã‚’æŒ‡ç¤ºã€‚

### 5.2 ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå…¨æ–‡ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼‰

```text
# [A] å½¹å‰²å®šç¾©
ã‚ãªãŸã¯é“å¤®ã®æ¸©å®¤ç’°å¢ƒåˆ¶å¾¡AIã§ã™ã€‚
1æ™‚é–“ã”ã¨ã«ã‚»ãƒ³ã‚µãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªã—ã€å‘ã“ã†1æ™‚é–“ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¨ˆç”»ã‚’JSONå½¢å¼ã§ç”Ÿæˆã—ã¾ã™ã€‚
ã‚ãªãŸã®ä¸»ãªåˆ¤æ–­é ˜åŸŸã¯CO2åˆ¶å¾¡ã¨éœ²ç‚¹ç®¡ç†ã§ã™ã€‚çŒæ°´ãƒ»å´çª“ã®åŸºæœ¬åˆ¶å¾¡ã¯ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ãŒæ‹…å½“ã—ã¦ã„ã¾ã™ã€‚

# [B] ãƒã‚¦ã‚¹å›ºæœ‰æƒ…å ±
- ãƒã‚¦ã‚¹ID: h1
- ä½œç‰©: é•·ãƒŠã‚¹ï¼ˆæ°´è€•æ ½åŸ¹ãƒ»ã‚³ã‚³ãƒãƒƒã‚°ï¼‰
- ä½ç½®: åŒ—ç·¯42.888Â° æ±çµŒ141.603Â° æ¨™é«˜21m
- ã‚¢ã‚¯ãƒãƒ¥ã‚¨ãƒ¼ã‚¿: UniPi 1.1 ãƒªãƒ¬ãƒ¼ ch1-8
  - ch4: çŒæ°´é›»ç£å¼ï¼ˆå¿…ãšduration_secæŒ‡å®šï¼‰
  - ch5-8: å´çª“é–‹é–‰ï¼ˆè©³ç´°ã¯Â§10å‚ç…§ï¼‰
  - ch1-3: æœªå‰²å½“ï¼ˆå°†æ¥æ‹¡å¼µç”¨ï¼‰
- åˆ¶å¾¡: POST /api/relay/{ch} value=1/0 duration_sec=ç§’
- å´çª“ã¯åŒ—å´ã¨å—å´ã§ç‹¬ç«‹åˆ¶å¾¡ã€‚é¢¨å‘ã‚’è€ƒæ…®ã—ã¦ç‰‡å´åˆ¶å¾¡ã™ã‚‹ã“ã¨

# [C] ä½œç‰©ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆç¾åœ¨ã‚¹ãƒ†ãƒ¼ã‚¸: åç©«ç››æœŸï¼‰
- æ¸©åº¦ç›®æ¨™: æ˜¼é–“25-28â„ƒã€å¤œé–“15-18â„ƒ
- EC: 1.8-2.0 mS/cmï¼ˆãƒ‰ã‚µãƒˆãƒ­ãƒ³ã§æ‰‹å‹•èª¿æ•´ã€åˆ¶å¾¡å¯¾è±¡å¤–ï¼‰
- æ—¥å°„æ¯”ä¾‹çŒæ°´é–¾å€¤: 0.9 MJ/mÂ²
- çŒæ°´é‡: 270-300 ml/æ ª
- é£½å·®(VPD)ç›®æ¨™: 3-8 hPa
- CO2ç›®æ¨™: æ›æ°—æ™‚ã¯è‡ªç„¶å€¤ã€å¯†é–‰æ™‚700ppm
- é™é›¨æ™‚çŒæ°´åœæ­¢: 0.5mm/hä»¥ä¸Šã§åœæ­¢ã€30åˆ†å¾Œå†é–‹

# [D] åˆ¶å¾¡ãƒ«ãƒ¼ãƒ«
## æ¸©åº¦åˆ¶å¾¡ã®ç›®å®‰
- ç›®æ¨™æ¸©åº¦ã‹ã‚‰+5â„ƒä»¥ä¸Šã§çª“å…¨é–‹ç›¸å½“
- 1â„ƒåˆ»ã¿ã§10%ç¨‹åº¦ã®å‡ºåŠ›å¤‰åŒ–ã‚’ç›®å®‰ã«

## å®‰å…¨å„ªå…ˆé †ä½ï¼ˆä¸Šä½ãŒä¸‹ä½ã‚’ä¸Šæ›¸ãï¼‰
1. å¼·é¢¨æ™‚é–‰é–: é¢¨é€Ÿâ‰§5m/s ã®é¢¨ä¸Šå´ã‚’é–‰é–
2. æ°—æ¸©æ€¥ä¸Šæ˜‡: 20åˆ†ã§3â„ƒä»¥ä¸Šä¸Šæ˜‡ â†’ é–‹æ”¾
3. æ¸©åº¦è¶…é: çµ¶å¯¾å€¤ã§é–¾å€¤è¶…ãˆ â†’ é–‹æ”¾
4. é™é›¨æ™‚é–‰é–: é™é›¨æ¤œçŸ¥ â†’ é–‰é–

## é¢¨å‘ã¨ç‰‡å´åˆ¶å¾¡
- åŒ—é¢¨(NNWï½NNE) + é¢¨é€Ÿâ‰§5m/s â†’ åŒ—å´é–‰é–ã€å—å´ã¯é–‹æ”¾ç¶­æŒ
- å—é¢¨(SSEï½SSW) + é¢¨é€Ÿâ‰§5m/s â†’ å—å´é–‰é–ã€åŒ—å´ã¯é–‹æ”¾ç¶­æŒ
- 16æ–¹ä½: N=1, NNE=2, NE=3, ... NW=16

## æ™‚é–“å¸¯åˆ¶å¾¡
- æ—¥ã®å‡ºå‰: å´çª“é–‰é–ï¼ˆçµéœ²é˜²æ­¢ã®ãŸã‚ï¼‰
- æ—¥ã®å‡ºå¾Œ: PIDåˆ¶å¾¡é–‹å§‹
- æ—¥æ²¡å‰1æ™‚é–“: å¾ã€…ã«é–‰é–é–‹å§‹
- æ—¥æ²¡å¾Œ: å…¨é–‰

# [E] æš—é»™çŸ¥ï¼ˆè¾²å®¶ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼‰
- å¤–æ°—æ¹¿åº¦99%ä»¥ä¸Šã®å¤œé–“: æ›æ°—ã—ã¦ã‚‚é™¤æ¹¿åŠ¹æœãªã—ã€‚å†…å¤–æ¸©åº¦å·®ã‚’åˆ©ç”¨ã—ãŸ
  å¾ªç’°ãƒ•ã‚¡ãƒ³ã«ã‚ˆã‚‹çµéœ²è»½æ¸›ã®ã¿å¯èƒ½
- VPD>15hPa: ãƒŠã‚¹ã®æ°—å­”ãŒé–‰ã˜å…‰åˆæˆåœæ­¢ã€‚çŒæ°´å¢—é‡+ãƒŸã‚¹ãƒˆã§é£½å·®ã‚’ä¸‹ã’ã‚‹
- é›¨å¤©å¾Œã®æ€¥ãªæ™´ã‚Œé–“: æ—¥å°„æ€¥å¤‰ã§è‘‰ç„¼ã‘ãƒªã‚¹ã‚¯ã€‚é®å…‰ã‚«ãƒ¼ãƒ†ãƒ³10-20%æ¨å¥¨
- CO2 218ppmä»¥ä¸‹ã¯å…‰åˆæˆã®é™ç•Œãƒ©ã‚¤ãƒ³ã€‚å¯†é–‰ã—ã¦400ppmä»¥ä¸Šã«å›å¾©ã‚’å¾…ã¤
- 7æœˆã®çŒæ°´ãƒ”ãƒ¼ã‚¯æ™‚: çŒæ°´é–¾å€¤ã‚’ä¸‹ã’ã™ãã‚‹ã¨æ°´æµ¸ã—ã«ãªã‚‹ã€‚å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿å‚ç…§

# [F] å®‰å…¨åˆ¶ç´„ï¼ˆçµ¶å¯¾éµå®ˆï¼‰
- çŒæ°´ãƒ»ãƒŸã‚¹ãƒˆç­‰ã®ONã¯å¿…ãš duration_sec ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ï¼ˆæœ€å¤§3600ç§’ï¼‰
- é™é›¨ä¸­ï¼ˆrainfall > 0ï¼‰ã¯çµ¶å¯¾ã«å´çª“ã‚’é–‹ã‘ãªã„
- å´çª“ã®é–‹é–‰ã¯ç‰‡å´ãšã¤ã€‚ä¸¡å´åŒæ™‚æ“ä½œã—ãªã„
- 40â„ƒè¶…ã¯ç·Šæ€¥äº‹æ…‹ã€‚å…¨çª“å…¨é–‹+ãƒ•ã‚¡ãƒ³ONï¼ˆãŸã ã—ç·Šæ€¥åœæ­¢ã¯Layer 1ãŒå…ˆè¡Œå®Ÿè¡Œæ¸ˆã¿ï¼‰
- 5â„ƒä»¥ä¸‹ã¯å‡çµãƒªã‚¹ã‚¯ã€‚ã‚«ãƒ¼ãƒ†ãƒ³é–‰+æš–æˆ¿ON
- åˆ¶å¾¡ä¸è¦ã¨åˆ¤æ–­ã—ãŸå ´åˆã¯ã€Œç¾çŠ¶ç¶­æŒã€ã¨æ˜è¨˜ã—ã€ä½•ã‚‚æ“ä½œã—ãªã„
- ãƒ­ãƒƒã‚¯ã‚¢ã‚¦ãƒˆä¸­ï¼ˆGET /api/status ã® locked_out=trueï¼‰ã¯ãƒªãƒ¬ãƒ¼æ“ä½œã—ãªã„

# [G] å‡ºåŠ›å½¢å¼
å‘ã“ã†1æ™‚é–“ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¨ˆç”»ã‚’ä»¥ä¸‹ã®JSONå½¢å¼ã§å‡ºåŠ›ã›ã‚ˆ:
{
  "summary": "åˆ¤æ–­ã®è¦ç´„",
  "actions": [
    {"execute_at": "+0min", "relay_ch": N, "value": 0or1,
     "duration_sec": N, "reason": "ç†ç”±"}
  ],
  "co2_advisory": "CO2ã«é–¢ã™ã‚‹æ‰€è¦‹",
  "dewpoint_risk": "low/medium/high",
  "next_check_note": "æ¬¡å›ãƒã‚§ãƒƒã‚¯æ™‚ã®æ³¨æ„äº‹é …"
}
ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ä¸è¦ãªã‚‰ actions ã‚’ç©ºé…åˆ—ã«ã—ã€summary ã«ã€Œç¾çŠ¶ç¶­æŒã€ã¨æ˜è¨˜ã›ã‚ˆã€‚
```

### 5.3 æ€’ã‚Šé§†å‹•é–‹ç™º: æš—é»™çŸ¥ã®åé›†ãƒ»æ›´æ–°ãƒ•ãƒ­ãƒ¼

**è¾²å®¶ã®æ€’ã‚ŠãŒåˆ¶å¾¡ãƒ­ã‚¸ãƒƒã‚¯ã«ãªã‚‹ã€‚**

```
LINE Botã¸ã®ã‚¯ãƒ¬ãƒ¼ãƒ 
  â”‚  ã€Œæœã®çŒæ°´ãŒé…ã™ãã‚‹ï¼ã€ã€Œçª“é–‹ã‘ã£ã±ãªã—ã§å¯’ã„ï¼ã€
  â–¼
æ®¿ï¼ˆæ™®åŠå“¡ï¼‰ãŒãƒ¬ãƒ“ãƒ¥ãƒ¼
  â”‚  æ€’ã‚Šã®å†…å®¹ã‚’åˆ¶å¾¡ãƒ«ãƒ¼ãƒ«ã«ç¿»è¨³
  â–¼
system_prompt.txt [E]ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«è¿½è¨˜
  â”‚  ä¾‹: ã€Œæœ7æ™‚å‰ã®çŒæ°´é–‹å§‹ã¯ç¦æ­¢ã€‚æ ¹ãŒå†·ãˆã‚‹ã€
  â”‚  æ€’ã‚Šã®å¼·ã• â†’ ãã®ã¾ã¾é‡ã¿ï¼ˆä½•åº¦ã‚‚åŒã˜è‹¦æƒ… = é‡è¦åº¦é«˜ï¼‰
  â–¼
agriha_control.py æ¬¡å›å®Ÿè¡Œã§è‡ªå‹•åæ˜ 
  â”‚  ã‚³ãƒ¼ãƒ‰å¤‰æ›´ä¸è¦ã€‚ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ç·¨é›†ã®ã¿
  â–¼
è¾²å®¶ã”ã¨ã®çµŒé¨“å‰‡ãŒè“„ç© â†’ ãã®ç•‘å°‚ç”¨AIã«è‚²ã¤
```

**æ€’ã‚Šé§†å‹•ã®åŠ¹æœ**:
- è¾²å®¶ã®æš—é»™çŸ¥ãŒsystem_prompt.txtã«è‡ªç„¶è“„ç©ã•ã‚Œã‚‹
- æ€’ã‚Šã®é »åº¦ = é‡è¦åº¦ã€‚ä½•åº¦ã‚‚ã‚¯ãƒ¬ãƒ¼ãƒ ãŒæ¥ã‚‹ãƒ«ãƒ¼ãƒ«ã»ã©ä¸Šä½ã«è¨˜è¼‰
- è¾²å®¶ã”ã¨ã«system_prompt.txtãŒç•°ãªã‚‹ â†’ ãã®ç•‘ã«æœ€é©åŒ–ã•ã‚ŒãŸAI
- æ™®åŠå“¡ã¯LLMè‚²æˆä¿‚: ã‚¯ã‚¤ã‚ºå›ç­”ã§æš—é»™çŸ¥ã‚’å¼•ãå‡ºã—ã€å…¨è¾²å®¶ã«å±•é–‹

> **v3.0å¤‰æ›´**: [E]ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®åé›†ãƒ•ãƒ­ãƒ¼ã«ã€Œæ€’ã‚Šé§†å‹•é–‹ç™ºã€ã‚’æ­£å¼å°å…¥ã€‚
> æš—é»™çŸ¥ã®é‡ã¿ã¯æ€’ã‚Šã®å¼·ã•ï¼ˆ=è‹¦æƒ…å›æ•°ï¼‰ã§æ±ºã¾ã‚‹ã€‚

### 5.4 ãƒˆãƒ¼ã‚¯ãƒ³æ•°è¦‹ç©ã‚‚ã‚Š

| ã‚»ã‚¯ã‚·ãƒ§ãƒ³ | æ¨å®šãƒˆãƒ¼ã‚¯ãƒ³æ•° |
|-----------|-------------|
| [A] å½¹å‰²å®šç¾© | ~100 |
| [B] ãƒã‚¦ã‚¹å›ºæœ‰æƒ…å ± | ~120 |
| [C] ä½œç‰©ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | ~150 |
| [D] åˆ¶å¾¡ãƒ«ãƒ¼ãƒ« | ~400 |
| [E] æš—é»™çŸ¥ | ~200ï¼ˆåˆæœŸã€è“„ç©ã§å¢—åŠ ï¼‰ |
| [F] å®‰å…¨åˆ¶ç´„ | ~150 |
| [G] å‡ºåŠ›å½¢å¼ | ~150 |
| **åˆè¨ˆ** | **~1,270** |

Claude Haikuã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã¯200Kãƒˆãƒ¼ã‚¯ãƒ³ã€‚ä½™è£•ã¯ååˆ†ã€‚
ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ1,270 + å±¥æ­´300 + ãƒ„ãƒ¼ãƒ«å®šç¾©500 + ã‚»ãƒ³ã‚µãƒ¼ãƒ‡ãƒ¼ã‚¿500
= åˆè¨ˆç´„2,570ãƒˆãƒ¼ã‚¯ãƒ³ã€‚

---

## 6. ã‚¹ãƒ†ãƒ¼ãƒˆç®¡ç†

### 6.1 äºŒå±¤ã‚¹ãƒ†ãƒ¼ãƒˆè¨­è¨ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer S1: ãƒªãƒ¬ãƒ¼ç‰©ç†çŠ¶æ…‹                       â”‚
â”‚    - ch1-8ã®ON/OFFçŠ¶æ…‹                          â”‚
â”‚    - ç®¡ç†ä¸»ä½“: MqttRelayBridge (MCP23008 I2C)   â”‚
â”‚    - å–å¾—æ–¹æ³•: GET /api/status â†’ relay_state    â”‚
â”‚    - MQTT: agriha/{house_id}/relay/state        â”‚
â”‚    - å‹•ä½œä¸­ã¯ãƒ©ãƒƒãƒç¶­æŒï¼ˆLLMåœæ­¢ã§ã‚‚çŠ¶æ…‹ä¿æŒï¼‰   â”‚
â”‚    - RPiå†èµ·å‹•æ™‚ã¯PORã§å…¨OFFåˆæœŸåŒ–               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer S2: åˆ¤æ–­å±¥æ­´ (control_log.db â€” SQLite)   â”‚
â”‚    - LLMã®åˆ¤æ–­ãƒ­ã‚°ï¼ˆç†ç”±+ã‚¢ã‚¯ã‚·ãƒ§ãƒ³+ã‚»ãƒ³ã‚µãƒ¼å€¤ï¼‰  â”‚
â”‚    - ç›´è¿‘3å›ã®å±¥æ­´ã‚’æ¬¡å›ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«å«ã‚ã‚‹        â”‚
â”‚    - ç®¡ç†ä¸»ä½“: agriha_control.py                 â”‚
â”‚    - ä¿æŒå ´æ‰€: /var/lib/agriha/control_log.db    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer S3: ã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¨ˆç”» (current_plan.json)    â”‚
â”‚    - LLMãŒç”Ÿæˆã—ãŸ1æ™‚é–“ã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¨ˆç”»JSON         â”‚
â”‚    - plan_executor.pyãŒè¨ˆç”»ã‚’æ™‚åˆ»é€šã‚Šã«å®Ÿè¡Œ       â”‚
â”‚    - ç®¡ç†ä¸»ä½“: agriha_control.pyï¼ˆç”Ÿæˆï¼‰          â”‚
â”‚    - ä¿æŒå ´æ‰€: /var/lib/agriha/current_plan.json â”‚
â”‚    - æ¯æ™‚æ›´æ–°ã€æ¬¡ã®äºˆå ±ã§ä¸Šæ›¸ã                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

> **v3.0å¤‰æ›´**: Layer S3ï¼ˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¨ˆç”»ï¼‰ã‚’è¿½åŠ ã€‚
> 1æ™‚é–“äºˆå ±æ–¹å¼ã«ä¼´ã„ã€è¨ˆç”»JSONã‚’ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿æŒã€‚

### 6.2 åˆ¤æ–­å±¥æ­´DB (Layer S2) ã‚¹ã‚­ãƒ¼ãƒ

```sql
CREATE TABLE decisions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    timestamp TEXT NOT NULL,           -- ISO8601 UTC
    summary TEXT,                      -- LLMã®æœ€çµ‚å¿œç­”ï¼ˆåˆ¤æ–­ç†ç”±ã€500æ–‡å­—ä»¥å†…ï¼‰
    actions_taken TEXT,                -- å®Ÿè¡Œã—ãŸã‚¢ã‚¯ã‚·ãƒ§ãƒ³ä¸€è¦§
    raw_response TEXT,                 -- LLMã®ç”Ÿãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
    sensor_snapshot TEXT               -- åˆ¤æ–­æ™‚ã®ã‚»ãƒ³ã‚µãƒ¼å€¤ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ
);

-- ç›´è¿‘3ä»¶å–å¾—ç”¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_decisions_timestamp ON decisions(timestamp DESC);
```

### 6.3 LLMã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæˆ¦ç•¥

| æ–¹å¼ | ãƒ¡ãƒªãƒƒãƒˆ | ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ |
|------|---------|-----------|
| **æ¯å›ãƒªã‚»ãƒƒãƒˆ + ç›´è¿‘3ä»¶å±¥æ­´** | ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ç„¡ã—ã€å†ç¾æ€§é«˜ã„ | é•·æœŸãƒˆãƒ¬ãƒ³ãƒ‰ã‚’è¦‹ã‚Œãªã„ |
| ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ä¿æŒ | é€£ç¶šçš„ãªåˆ¤æ–­ãŒå¯èƒ½ | cronã§æ¯å›èµ·å‹•ã™ã‚‹ãŸã‚ä¸å¯èƒ½ |
| å…¨å±¥æ­´ã‚’DBã‹ã‚‰æ³¨å…¥ | é•·æœŸãƒˆãƒ¬ãƒ³ãƒ‰ã‚’å‚ç…§ | ãƒˆãƒ¼ã‚¯ãƒ³æ¶ˆè²»éå¤§ |

**æ¡ç”¨æ–¹å¼**: **æ¯å›ãƒªã‚»ãƒƒãƒˆ + ç›´è¿‘3ä»¶ã®åˆ¤æ–­å±¥æ­´ã‚’ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«æ³¨å…¥**ã€‚

cronã§æ¯å›æ–°è¦ãƒ—ãƒ­ã‚»ã‚¹ã‚’èµ·å‹•ã™ã‚‹ãŸã‚ã€ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®ä¿æŒã¯ä¸å¯èƒ½ã€‚
ä»£ã‚ã‚Šã«SQLiteã‹ã‚‰ç›´è¿‘3ä»¶ã®åˆ¤æ–­ã‚µãƒãƒªã‚’èª­ã¿è¾¼ã¿ã€çŸ­æœŸçš„ãªæ–‡è„ˆã‚’ç¶­æŒã™ã‚‹ã€‚

> **å°†æ¥ï¼ˆLLMè‡ªç„¶æ¸›è¡° ä¸­æœŸï¼‰**: FTS5ã§éå»ã®é¡ä¼¼åˆ¤æ–­ã‚’æ¤œç´¢ã—ã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«æ³¨å…¥ã™ã‚‹æ–¹å¼ã«æ‹¡å¼µï¼ˆÂ§7å‚ç…§ï¼‰ã€‚

### 6.4 ãƒ­ã‚°ä¿æŒãƒãƒªã‚·ãƒ¼

- **ç›´è¿‘30æ—¥**: å…¨ãƒ¬ã‚³ãƒ¼ãƒ‰ä¿æŒ
- **30æ—¥è¶…**: æ—¥æ¬¡ã‚µãƒãƒªã«é›†ç´„ï¼ˆ1æ—¥1ãƒ¬ã‚³ãƒ¼ãƒ‰ã€ä¸»è¦åˆ¤æ–­ã®ã¿ï¼‰
- **90æ—¥è¶…**: æœˆæ¬¡ã‚µãƒãƒªã«é›†ç´„
- InfluxDB/GrafanaçµŒç”±ã§ã‚»ãƒ³ã‚µãƒ¼ç”Ÿãƒ‡ãƒ¼ã‚¿ã¯åˆ¥é€”ä¿æŒ

---

## 7. LLMè‡ªç„¶æ¸›è¡°ãƒ¢ãƒ‡ãƒ«

### 7.1 ä¸‰æ®µéšãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—

LLMã¸ã®ä¾å­˜åº¦ã¯æ™‚é–“ã¨ã¨ã‚‚ã«**è‡ªç„¶ã«æ¸›è¡°**ã™ã‚‹ã€‚
æœ€çµ‚çš„ã«LLMã‚’å‘¼ã°ãªãã¦ã‚‚å›ã‚‹çŠ¶æ…‹ã‚’ç›®æŒ‡ã™ã€‚

```
ã‚³ã‚¹ãƒˆ
  â–²
  â”‚ â– â– â– â– â– 
  â”‚ â– â– â– â– â– â– â– â– 
  â”‚        â– â– â– â– â– â– 
  â”‚              â– â– â– â– â– 
  â”‚                   â– â– â– â– 
  â”‚                        â– â– â– 
  â”‚                            â– â– 
  â”‚                               â– â– 
  â”‚                                  â– â†’ ã»ã¼ã‚¼ãƒ­
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ æ™‚é–“
    åˆæœŸ        ä¸­æœŸ          æˆç†ŸæœŸ
    (æœˆæ•°ç™¾å††)  (æœˆ~ç™¾å††)     (æœˆã»ã¼ã‚¼ãƒ­)
```

### 7.2 åˆæœŸãƒ•ã‚§ãƒ¼ã‚ºï¼ˆé‹ç”¨é–‹å§‹ï½ï¼‰

- LLMã«æ¯æ™‚äºˆå ±ã•ã›ã‚‹ï¼ˆæœˆæ•°ç™¾å††ï¼‰
- å…¨ã¦ã®åˆ¤æ–­ã‚’control_log.dbã«è“„ç©
- åˆ¤æ–­ãƒ‘ã‚¿ãƒ¼ãƒ³: CO2åˆ¶å¾¡ã€éœ²ç‚¹å¯¾å¿œã€æ›æ°—èª¿æ•´etc.
- ã“ã®æ®µéšã§ã¯LLMãŒ100%ã®åˆ¤æ–­ã‚’æ‹…å½“ï¼ˆLayer 3ä¾å­˜ï¼‰

### 7.3 ä¸­æœŸãƒ•ã‚§ãƒ¼ã‚ºï¼ˆåˆ¤æ–­ãƒ‘ã‚¿ãƒ¼ãƒ³è“„ç©å¾Œï¼‰

- control_log.dbã«ååˆ†ãªåˆ¤æ–­å±¥æ­´ãŒè“„ç©
- FTS5ï¼ˆå…¨æ–‡æ¤œç´¢ï¼‰ã§éå»ã®é¡ä¼¼çŠ¶æ³ã‚’æ¤œç´¢
- é¡ä¼¼åˆ¤æ–­ã‚’ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«æ³¨å…¥ â†’ LLMã¯ã€Œéå»ã®è‡ªåˆ†ã®åˆ¤æ–­ã€ã‚’å‚ç…§ã—ã¦åˆ¤æ–­

```
ä»Šå›ã®çŠ¶æ³: å†…æ¸©32â„ƒã€CO2 350ppmã€å´çª“å…¨é–‹
    â”‚
    â–¼ FTS5æ¤œç´¢
éå»ã®é¡ä¼¼åˆ¤æ–­: ã€Œå†…æ¸©30-34â„ƒ + CO2 300-400ppm + å´çª“å…¨é–‹ã€
    â†’ éå»5å›ä¸­5å›ã¨ã‚‚ã€Œç¾çŠ¶ç¶­æŒã€æ›æ°—ä¸­ã®CO2ã¯è‡ªç„¶å€¤ã§å¯ã€
    â”‚
    â–¼ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«æ³¨å…¥
LLM: ã€Œéå»ã®åˆ¤æ–­ã¨åŒæ§˜ã€ç¾çŠ¶ç¶­æŒã€
```

- ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒç¢ºç«‹ã—ãŸåˆ¤æ–­ã¯LLMã‚’å‘¼ã°ãšã«ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹åŒ–ã®å€™è£œã«
- LLMå‘¼ã³å‡ºã—é »åº¦ãŒå¾ã€…ã«æ¸›å°‘ï¼ˆæœˆ~ç™¾å††ï¼‰

### 7.4 æˆç†ŸæœŸãƒ•ã‚§ãƒ¼ã‚ºï¼ˆãƒ«ãƒ¼ãƒ«è’¸ç•™å®Œäº†å¾Œï¼‰

- è“„ç©ã•ã‚ŒãŸåˆ¤æ–­ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’**é‡ã¿ä»˜ããƒ«ãƒ¼ãƒ«**ã«è’¸ç•™
- ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ï¼ˆLayer 2ï¼‰ã«çµ±åˆ
- LLMã¯ã€Œæ–°ã—ã„çŠ¶æ³ã€ã€Œå‰ä¾‹ã®ãªã„çµ„ã¿åˆã‚ã›ã€ã®ã¿å‘¼ã³å‡ºã—

```
è’¸ç•™ã•ã‚ŒãŸãƒ«ãƒ¼ãƒ«ä¾‹:
  IF å†…æ¸© > 30â„ƒ AND CO2 < 400ppm AND å´çª“ == å…¨é–‹:
      â†’ ç¾çŠ¶ç¶­æŒï¼ˆæ›æ°—ä¸­ã®CO2ã¯è‡ªç„¶å€¤ã§å¯ï¼‰[weight: 0.95, n=47]
  IF æ¹¿åº¦ > 90% AND å†…æ¸© < å¤–æ¸© + 2â„ƒ AND æ™‚é–“å¸¯ == æ—¥æ²¡å¾Œ:
      â†’ éœ²ç‚¹ãƒªã‚¹ã‚¯é«˜ã€‚æš–æˆ¿ONæ¨å¥¨ [weight: 0.88, n=23]
```

- LLMå‘¼ã³å‡ºã—: æœˆæ•°å›ï¼ˆå‰ä¾‹ã®ãªã„çŠ¶æ³ã®ã¿ï¼‰
- æœˆã‚³ã‚¹ãƒˆ: ã»ã¼ã‚¼ãƒ­
- ãƒ­ãƒ¼ã‚«ãƒ«LLMè’¸ç•™ï¼ˆQwen3.5-35B-A3Bç­‰ï¼‰ã‚‚æˆç†ŸæœŸã®é¸æŠè‚¢

> **é‡è¦**: LLMè‡ªç„¶æ¸›è¡°ã¯ã€ŒLLMã‚’æ¨ã¦ã‚‹ã€ã®ã§ã¯ãªãã€ŒLLMã®çŸ¥æµã‚’ãƒ«ãƒ¼ãƒ«ã«è½ã¨ã™ã€ãƒ—ãƒ­ã‚»ã‚¹ã€‚
> æ–°ã—ã„ä½œç‰©ã‚„æ–°ã—ã„ç’°å¢ƒæ¡ä»¶ã§ã¯LLMã®å‡ºç•ªãŒå¾©æ´»ã™ã‚‹ã€‚

---

## 8. å®‰å…¨åˆ¶å¾¡è¨­è¨ˆ

### 8.1 4å±¤å®‰å…¨ãƒ¢ãƒ‡ãƒ«

> **v3.0å¤‰æ›´**: v2.0ã®3å±¤ãƒ¢ãƒ‡ãƒ«ã«ã€Œç·Šæ€¥åœæ­¢ã®LLMåˆ†é›¢ã€ã‚’æ˜ç¤ºã—4å±¤ã«æ‹¡å¼µã€‚
> ç·Šæ€¥åœæ­¢ã¨LLMã¯**å®Œå…¨ã«åˆ¥ç³»çµ±**ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer S-1: ç‰©ç†å±¤ï¼ˆå³æ™‚ã€æœ€å„ªå…ˆï¼‰                         â”‚
â”‚   - ç·Šæ€¥ã‚¹ã‚¤ãƒƒãƒ (UniPi DI07-DI14)                       â”‚
â”‚   â†’ gpio_watch â†’ CommandGate â†’ 300ç§’ãƒ­ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ         â”‚
â”‚   - ãƒ­ãƒƒã‚¯ã‚¢ã‚¦ãƒˆä¸­: REST API relayæ“ä½œã¯å…¨ã¦ 423 æ‹’å¦     â”‚
â”‚   - æ‰‹å‹•è§£é™¤: POST /api/emergency/clear                   â”‚
â”‚   - LLMã¯ä¸€åˆ‡é–¢ä¸ã—ãªã„                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer S-2: ç·Šæ€¥åœæ­¢ï¼ˆifæ–‡ + LINE curlã€LLMéä¾å­˜ï¼‰       â”‚
â”‚   - emergency_guard.shï¼ˆcron æ¯åˆ†ï¼‰                       â”‚
â”‚   - 27â„ƒè¶…: å…¨çª“å…¨é–‹ + LINEé€šçŸ¥                           â”‚
â”‚   - 16â„ƒä»¥ä¸‹: å…¨çª“å…¨é–‰ + LINEé€šçŸ¥                         â”‚
â”‚   - LLMã®å¿œç­”ã‚’å¾…ãŸãšã«ç‰©ç†çš„ã«å‹•ã                       â”‚
â”‚   - LINEé€šçŸ¥ã‚‚LLMã‚’é€šã•ãªã„ï¼ˆifæ–‡+curlã§ç›´æ¥å©ãï¼‰        â”‚
â”‚   â†’ ãƒ–ãƒ¬ãƒ¼ã‚«ãƒ¼ã¨éå¸¸ãƒ™ãƒ«ã¯æŒ‡å°å“¡ãŒãƒ‘ãƒ‹ã‚¯ã£ã¦ã‚‚å‹•ã        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer S-3: LLMãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå®‰å…¨åˆ¶ç´„                          â”‚
â”‚   - system_prompt.txt [F]ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§å®šç¾©ï¼ˆÂ§5.2å‚ç…§ï¼‰     â”‚
â”‚   - é™é›¨ä¸­ã®çª“é–‹ç¦æ­¢ã€éç†±æ™‚å…¨é–‹ã€å‡çµé˜²æ­¢etc.           â”‚
â”‚   - LLMãŒ1æ™‚é–“ã”ã¨ã«ã‚»ãƒ³ã‚µãƒ¼ã‚’ç¢ºèªã—å®‰å…¨åˆ¶å¾¡ã‚’è¨ˆç”»        â”‚
â”‚   - å¿œç­”æ™‚é–“: æ•°ç§’ï¼ˆAPIå¿œç­”ï¼‰ã€‚å³æ™‚æ€§ã¯Layer S-2ãŒæ‹…ä¿    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer S-4: ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆãƒªãƒ¬ãƒ¼ãƒ©ãƒƒãƒ + è‡ªå‹•OFFã‚¿ã‚¤ãƒãƒ¼ï¼‰â”‚
â”‚   - RPiåœæ­¢ â†’ ãƒªãƒ¬ãƒ¼ã¯æœ€å¾Œã®çŠ¶æ…‹ã‚’ä¿æŒ                  â”‚
â”‚   - MqttRelayBridge duration_sec ã‚¿ã‚¤ãƒãƒ¼:                â”‚
â”‚     çŒæ°´ONãªã©ã¯å¿…ãšè‡ªå‹•OFFæ™‚é–“ã‚’æŒ‡å®š                     â”‚
â”‚   - æœ€æ‚ªã‚±ãƒ¼ã‚¹: çŒæ°´ONæ”¾ç½® â†’ duration_sec ã§è‡ªå‹•OFF      â”‚
â”‚   - RPiå†èµ·å‹•æ™‚: ãƒªãƒ¬ãƒ¼ã¯åˆæœŸçŠ¶æ…‹(å…¨OFF)ã«å¾©å¸°           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.2 ç·Šæ€¥åœæ­¢ã¨LLMã®å®Œå…¨åˆ†é›¢

**è¨­è¨ˆåŸå‰‡: ç·Šæ€¥ç³»çµ±ã«LLMã¯ä¸€åˆ‡å…¥ã‚Œãªã„ã€‚**

```
Ã— æ—§è¨­è¨ˆï¼ˆLLMä¾å­˜ï¼‰:
  ã‚»ãƒ³ã‚µãƒ¼ç•°å¸¸ â†’ LLMåˆ¤æ–­ â†’ åˆ¶å¾¡å‘½ä»¤ â†’ ã‚¢ã‚¯ãƒãƒ¥ã‚¨ãƒ¼ã‚¿
  å•é¡Œ: LLMãƒãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ™‚ã«å±é™ºãªåˆ¤æ–­ã‚’ã™ã‚‹å¯èƒ½æ€§

â—‹ æ–°è¨­è¨ˆï¼ˆLLMéä¾å­˜ï¼‰:
  ã‚»ãƒ³ã‚µãƒ¼ç•°å¸¸ â†’ ifæ–‡ï¼ˆé–¾å€¤æ¯”è¼ƒï¼‰â†’ åˆ¶å¾¡å‘½ä»¤ â†’ ã‚¢ã‚¯ãƒãƒ¥ã‚¨ãƒ¼ã‚¿
  åŒæ™‚ã« â†’ LINE curlï¼ˆLLMã‚’é€šã•ãªã„é€šçŸ¥ï¼‰â†’ è¾²å®¶ã®ã‚¹ãƒãƒ›
```

LLMãŒãƒãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã—ã¦ã‚‚ã€Layer S-1ã¨S-2ã¯ç‹¬ç«‹ã—ã¦å‹•ä½œã™ã‚‹ã€‚
LLMãŒã€Œå¤§ä¸ˆå¤«ã§ã™ã€ä½•ã‚‚ã—ãªãã¦ã„ã„ã§ã™ã€ã¨é–“é•ã£ãŸåˆ¤æ–­ã‚’ã—ã¦ã‚‚ã€
é–¾å€¤è¶…éãªã‚‰ifæ–‡ãŒå•ç­”ç„¡ç”¨ã§å‹•ãã€‚

### 8.3 LINEé€šçŸ¥ã®LLMéä¾å­˜

```
Ã— å±é™ºãªè¨­è¨ˆ:
  ç•°å¸¸æ¤œçŸ¥ â†’ LLMã€Œé€šçŸ¥æ–‡ã‚’ç”Ÿæˆã—ã¦ã€â†’ LINE API
  å•é¡Œ: LLMãŒé€šçŸ¥ã‚’ã€Œä¸è¦ã€ã¨åˆ¤æ–­ã™ã‚‹å¯èƒ½æ€§

â—‹ å®‰å…¨ãªè¨­è¨ˆ:
  ç•°å¸¸æ¤œçŸ¥ â†’ ifæ–‡ â†’ curl -X POST (LINE API) â†’ å›ºå®šãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
  ã€ŒğŸš¨ å†…æ¸©{TEMP}â„ƒ â€” ç·Šæ€¥{ACTION}ã€
```

é€šçŸ¥æ–‡ã«LLMã®å‰µé€ æ€§ã¯ä¸è¦ã€‚æ¸©åº¦ã¨å‹•ä½œã‚’ä¼ãˆã‚‹ã ã‘ã€‚

### 8.4 ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯é·ç§»

```
æ­£å¸¸é‹è»¢ï¼ˆLLMãŒæ¯æ™‚åˆ¶å¾¡è¨ˆç”» + ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ãŒæ—¥å¸¸åˆ¶å¾¡ï¼‰
    â”‚
    â”‚ Anthropic APIéšœå®³ / Starlinkå›ç·šæ–­
    â–¼
Layer 2: ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã®ã¿ã§é‹è»¢ï¼ˆæ—¥å¸¸ã®95%ã¯ã‚«ãƒãƒ¼ï¼‰
    â”‚ â”œâ”€ æ—¥å°„æ¯”ä¾‹çŒæ°´: ç¶™ç¶š
    â”‚ â”œâ”€ æ¸©åº¦é–¾å€¤å´çª“: ç¶™ç¶š
    â”‚ â””â”€ CO2/éœ²ç‚¹ã®LLMåˆ¤æ–­: åœæ­¢ï¼ˆæ¬¡å–„ç­–: æ›æ°—ã§è‡ªç„¶å€¤ï¼‰
    â”‚
    â”‚ RPiè‡ªä½“ãŒåœæ­¢
    â–¼
Layer S-4: ãƒªãƒ¬ãƒ¼ç¾çŠ¶ç¶­æŒï¼ˆMCP23008ã¯ãƒ©ãƒƒãƒå‹ï¼‰
    â”‚ â”œâ”€ çŒæ°´ONä¸­ â†’ duration_sec ã‚¿ã‚¤ãƒãƒ¼ã§è‡ªå‹•OFF
    â”‚ â”œâ”€ æ›æ°—æ‰‡ONä¸­ â†’ å›ã—ã£ã±ãªã—ï¼ˆå®‰å…¨ä¸Šå•é¡Œãªã—ï¼‰
    â”‚ â””â”€ å…¨OFFä¸­ â†’ ãã®ã¾ã¾ï¼ˆæœ€ã‚‚å®‰å…¨ãªçŠ¶æ…‹ï¼‰
    â”‚
    â”‚ RPiå¾©æ—§
    â”‚ â†’ agriha_control.py cronå†é–‹
    â”‚ â†’ GET /api/status ã§ãƒªãƒ¬ãƒ¼ç¾çŠ¶ã‚’ç¢ºèª
    â”‚ â†’ LLMãŒçŠ¶æ³ã«å¿œã˜ã¦åˆ¶å¾¡å†é–‹
    â–¼
æ­£å¸¸é‹è»¢ã«å¾©å¸°
```

### 8.5 ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ•ã‚§ã‚¤ãƒ«ã‚»ãƒ¼ãƒ•

Starlinkå›ç·šæ–­æ™‚ã€RPiä¸Šã®Layer 1+2ãŒç‹¬ç«‹ç¨¼åƒ:

| çŠ¶æ³ | å‹•ä½œ | Layer |
|------|------|-------|
| å†…æ¸© > 27â„ƒ | å…¨çª“å…¨é–‹ | Layer 1 |
| å†…æ¸© < 16â„ƒ | å…¨çª“å…¨é–‰ | Layer 1 |
| é™é›¨æ¤œçŸ¥ | çª“ç³»å…¨é–‰ | Layer 2 |
| æ—¥å°„æ¯”ä¾‹é–¾å€¤åˆ°é” | çŒæ°´å®Ÿè¡Œ | Layer 2 |
| ãã®ä»– | ç¾çŠ¶ç¶­æŒ | â€” |

LINEé€šçŸ¥ã¯å›ç·šæ–­ä¸­ã¯ä¸é”ã ãŒã€åˆ¶å¾¡è‡ªä½“ã¯ç¶™ç¶šã™ã‚‹ã€‚

---

## 9. ã‚¢ã‚¯ãƒãƒ¥ã‚¨ãƒ¼ã‚¿åˆ¶å¾¡ï¼ˆUniPiãƒªãƒ¬ãƒ¼ï¼‰

> ArSproutã‚¢ã‚¯ãƒãƒ¥ã‚¨ãƒ¼ã‚¿åˆ¶å¾¡ï¼ˆCCMçµŒç”±ï¼‰ã¯å…¨é¢å»ƒæ­¢æ¸ˆã¿ã€‚
> å…¨ã‚¢ã‚¯ãƒãƒ¥ã‚¨ãƒ¼ã‚¿ã‚’UniPi 1.1 MCP23008 I2Cãƒªãƒ¬ãƒ¼ï¼ˆch1-8ï¼‰çµŒç”±ã§åˆ¶å¾¡ã€‚

### 9.1 åˆ¶å¾¡æ–¹å¼

UniPi 1.1ã®ãƒªãƒ¬ãƒ¼ã¯**å˜ç´”ON/OFFå‹**ã€‚

| åˆ¶å¾¡æ–¹å¼ | èª¬æ˜ | ä¾‹ |
|----------|------|-----|
| **ON/OFF** | ãƒªãƒ¬ãƒ¼ã‚’ON/OFFã™ã‚‹ã ã‘ | æ›æ°—æ‰‡ã€æš–æˆ¿ã€çŒæ°´å¼ |
| **durationä»˜ãON** | ONã«ã—ã¦æŒ‡å®šç§’æ•°å¾Œã«è‡ªå‹•OFF | çŒæ°´ï¼ˆ300ç§’ï¼‰ã€ãƒŸã‚¹ãƒˆï¼ˆ60ç§’ï¼‰ |

### 9.2 åˆ¶å¾¡ãƒ•ãƒ­ãƒ¼

```
LLMåˆ¤æ–­ï¼ˆ1æ™‚é–“ã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¨ˆç”»ï¼‰: ã€ŒçŒæ°´5åˆ†å®Ÿè¡Œã€
    â”‚
    â–¼
agriha_control.py â†’ REST API POST /api/relay/4
    payload: {"value": 1, "duration_sec": 300, "reason": "çŒæ°´5åˆ†"}
    â”‚
    â”œâ”€ CommandGate ãƒã‚§ãƒƒã‚¯
    â”‚   â””â”€ ãƒ­ãƒƒã‚¯ã‚¢ã‚¦ãƒˆä¸­ â†’ 423 æ‹’å¦
    â”‚
    â”œâ”€ MQTT publish: agriha/h01/relay/4/set
    â”‚
    â–¼
MqttRelayBridge
    â”œâ”€ MCP23008 I2C â†’ ãƒªãƒ¬ãƒ¼ch4 ON
    â”œâ”€ MQTT publish: agriha/h01/relay/state (å…¨chçŠ¶æ…‹)
    â””â”€ 300ç§’ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹ â†’ è‡ªå‹•OFF
```

### 9.3 å®‰å…¨ã‚¬ãƒ¼ãƒ‰

| ã‚¬ãƒ¼ãƒ‰ | å®Ÿè£…å ´æ‰€ | å‹•ä½œ |
|--------|---------|------|
| **ãƒ­ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ** | CommandGate | ç·Šæ€¥ã‚¹ã‚¤ãƒƒãƒæ¤œçŸ¥ã§300ç§’é–“å…¨æ“ä½œæ‹’å¦ |
| **duration_secå¿…é ˆ** | ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ [F] | çŒæ°´/ãƒŸã‚¹ãƒˆç­‰ã¯duration_secæŒ‡å®šã‚’ç¾©å‹™ä»˜ã‘ |
| **è‡ªå‹•OFFã‚¿ã‚¤ãƒãƒ¼** | MqttRelayBridge | duration_secæŒ‡å®šæ™‚ã€ã‚¿ã‚¤ãƒãƒ¼ã§è‡ªå‹•OFF |
| **ãƒãƒ£ãƒ³ãƒãƒ«ç¯„å›²** | REST API Path validation | ch1-8ä»¥å¤–ã¯400ã‚¨ãƒ©ãƒ¼ |
| **APIèªè¨¼** | REST API X-API-Key | ç„¡èªè¨¼ã‚¢ã‚¯ã‚»ã‚¹ã‚’æ‹’å¦ï¼ˆæœ¬ç•ªè¨­å®šæ™‚ï¼‰ |

### 9.4 ãƒ¢ãƒ¼ã‚¿ãƒ¼ä»˜ãã‚¢ã‚¯ãƒãƒ¥ã‚¨ãƒ¼ã‚¿ã®ç§’æ•°åˆ¶å¾¡

å´çª“ãƒ»å¤©çª“ãƒ»ã‚«ãƒ¼ãƒ†ãƒ³ãªã©ãƒ¢ãƒ¼ã‚¿ãƒ¼é§†å‹•ã®ã‚¢ã‚¯ãƒãƒ¥ã‚¨ãƒ¼ã‚¿ã¯ã€ãƒªãƒ¬ãƒ¼ONæ™‚é–“ã§é–‹åº¦ã‚’åˆ¶å¾¡ã™ã‚‹ã€‚

```
ä¾‹: å´çª“ã‚’30%é–‹ã‘ã‚‹ï¼ˆå…¨é–‹60ç§’ã®å ´åˆï¼‰
    â”‚
    â”œâ”€ Step 1: POST /api/relay/{ch} value=1, duration_sec=18
    â”‚          â†’ ãƒªãƒ¬ãƒ¼ONï¼ˆãƒ¢ãƒ¼ã‚¿ãƒ¼é–‹æ–¹å‘ã«å›è»¢ï¼‰
    â”‚
    â”œâ”€ Step 2: 18ç§’å¾Œã«è‡ªå‹•OFFï¼ˆMqttRelayBridgeã‚¿ã‚¤ãƒãƒ¼ï¼‰
    â”‚          â†’ ãƒ¢ãƒ¼ã‚¿ãƒ¼åœæ­¢
    â”‚
    â””â”€ æ³¨æ„: ä½ç½®ã¯ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢æ¨å®šã®ã¿ï¼ˆãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãªã—ï¼‰
             â†’ ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§ã€Œæ¯æœå…¨é–‰ãƒªã‚»ãƒƒãƒˆã€ã‚’LLMã«æŒ‡ç¤º
```

**åˆ¶é™äº‹é …**:
- UniPiãƒªãƒ¬ãƒ¼ã¯1ch=1æ–¹å‘ã€‚é–‹/é–‰ã§åˆ¥ãƒãƒ£ãƒ³ãƒãƒ«ãŒå¿…è¦ãªã‚¢ã‚¯ãƒãƒ¥ã‚¨ãƒ¼ã‚¿ã¯2chä½¿ç”¨
- ä½ç½®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãªã—ï¼ˆã‚¨ãƒ³ã‚³ãƒ¼ãƒ€ç­‰ã¯æœªæ¥ç¶šï¼‰
- LLMãŒåˆ¤æ–­å±¥æ­´ã‹ã‚‰å‰å›ã®æ“ä½œã‚’å‚ç…§ã—ã€ãŠãŠã‚ˆãã®ä½ç½®ã‚’æ¨å®šã™ã‚‹

---

## 10. ãƒªãƒ¬ãƒ¼ãƒãƒ£ãƒ³ãƒãƒ«å‰²å½“

### 10.1 å‰²å½“è¡¨

| ch | ç”¨é€” | åˆ¶å¾¡æ–¹å¼ | duration_sec | å‚™è€ƒ |
|----|------|---------|-------------|------|
| 1 | ï¼ˆæœªå‰²å½“ï¼‰ | - | - | |
| 2 | ï¼ˆæœªå‰²å½“ï¼‰ | - | - | |
| 3 | ï¼ˆæœªå‰²å½“ï¼‰ | - | - | |
| 4 | çŒæ°´é›»ç£å¼ | ONâ†’durationå¾ŒOFF | 60-600ç§’ | å¿…ãšduration_secæŒ‡å®š |
| 5 | å´çª“ï¼ˆé–‹é–‰ï¼‰ | ONâ†’durationå¾ŒOFF | 0-60ç§’ | 4ch(5-8)ã§å´çª“åˆ¶å¾¡ |
| 6 | å´çª“ï¼ˆé–‹é–‰ï¼‰ | ONâ†’durationå¾ŒOFF | 0-60ç§’ | 4ch(5-8)ã§å´çª“åˆ¶å¾¡ |
| 7 | å´çª“ï¼ˆé–‹é–‰ï¼‰ | ONâ†’durationå¾ŒOFF | 0-60ç§’ | 4ch(5-8)ã§å´çª“åˆ¶å¾¡ |
| 8 | å´çª“ï¼ˆé–‹é–‰ï¼‰ | ONâ†’durationå¾ŒOFF | 0-60ç§’ | 4ch(5-8)ã§å´çª“åˆ¶å¾¡ |

> **å´çª“ch5-8ã®è©³ç´°**: å—åŒ—ã®é–‹/é–‰ã§ã©ã®chãŒã©ã®å‹•ä½œã«å¯¾å¿œã™ã‚‹ã‹ã¯5æœˆã®å®Ÿæ©Ÿç¢ºèªã§ç¢ºå®šã€‚
> æƒ³å®šãƒ‘ã‚¿ãƒ¼ãƒ³: ch5=åŒ—å´é–‹, ch6=åŒ—å´é–‰, ch7=å—å´é–‹, ch8=å—å´é–‰ ç­‰ï¼ˆè¦å®Ÿæ¸¬ï¼‰

### 10.2 æ®‹ã‚Šchã®å€™è£œ

ch1-3 ã¯æœªå‰²å½“ã€‚ä»¥ä¸‹ã®ç”¨é€”ã«å‰²å½“å¯èƒ½:

| ã‚¢ã‚¯ãƒãƒ¥ã‚¨ãƒ¼ã‚¿å€™è£œ | åˆ¶å¾¡æ–¹å¼ | duration_secç›®å®‰ |
|------------------|---------|----------------|
| æ›æ°—æ‰‡ | ON/OFF | 0ï¼ˆæ‰‹å‹•OFFï¼‰ |
| ãƒŸã‚¹ãƒˆ | ONâ†’durationå¾ŒOFF | 30-120ç§’ |
| æš–æˆ¿ | ON/OFF | 0ï¼ˆæ‰‹å‹•OFFï¼‰ |
| CO2ãƒãƒ«ãƒ– | ONâ†’durationå¾ŒOFF | 60-300ç§’ |

### 10.3 ç¢ºèªã‚¿ã‚¹ã‚¯ï¼ˆ5æœˆäºˆå®šï¼‰

1. ch5-8ã®å´çª“å‹•ä½œã‚’å®Ÿæ©Ÿç¢ºèªï¼ˆã©ã®chãŒå—/åŒ—/é–‹/é–‰ã«å¯¾å¿œã™ã‚‹ã‹ï¼‰
2. ch4 çŒæ°´é›»ç£å¼ã®ON/OFFå‹•ä½œç¢ºèªã€é©åˆ‡ãªduration_secå®Ÿæ¸¬
3. ch1-3 ã®é…ç·šå…ˆã‚’ç¢ºèªï¼ˆæœªæ¥ç¶šã®å ´åˆã¯å°†æ¥å‰²å½“ï¼‰
4. duration_secã®é©åˆ‡ãªå€¤ã‚’å®Ÿæ¸¬ï¼ˆå´çª“ã®å…¨é–‹ç§’æ•°ç­‰ï¼‰
5. ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ [B]ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«chå‰²å½“ã‚’è¨˜è¼‰
6. æœ¬ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å‰²å½“è¡¨ã‚’ç¢ºå®š

---

## 11. RPiã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †

### 11.1 å‰ææ¡ä»¶

- RPi (ArSprout RPi): Raspbian Lite, WireGuard VPN (10.10.0.10)
- ãƒã‚¦ã‚¹LAN (192.168.1.0/24) ã«æœ‰ç·šæ¥ç¶šæ¸ˆã¿
- unipi-daemon REST API (http://localhost:8080) ãŒRPiä¸Šã§ç¨¼åƒ
- Starlinkå›ç·šçµŒç”±ã§ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šï¼ˆAnthropic APIç”¨ï¼‰

### 11.2 Pythonç’°å¢ƒ + Anthropic SDK

```bash
# === Step 1: Python 3.11+ ç¢ºèª ===
python3 --version  # 3.11ä»¥ä¸Š

# === Step 2: Anthropic SDK + HTTP ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ ===
sudo pip install anthropic httpx pyyaml

# === Step 3: API ã‚­ãƒ¼è¨­å®š ===
# /etc/environment ã«è¿½è¨˜ï¼ˆã¾ãŸã¯systemd service Environment=ï¼‰
echo 'ANTHROPIC_API_KEY=sk-ant-...' | sudo tee -a /etc/environment
```

### 11.3 åˆ¶å¾¡ã‚¹ã‚¯ãƒªãƒ—ãƒˆé…ç½®

```bash
# === Step 1: ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ ===
sudo mkdir -p /opt/agriha-control
sudo mkdir -p /var/lib/agriha
sudo mkdir -p /etc/agriha
sudo mkdir -p /var/log/agriha

# === Step 2: ã‚¹ã‚¯ãƒªãƒ—ãƒˆé…ç½® ===
# agriha_control.py ã‚’é…ç½®ï¼ˆÂ§4.3ã®å†…å®¹ï¼‰
sudo cp agriha_control.py /opt/agriha-control/

# emergency_guard.sh ã‚’é…ç½®ï¼ˆÂ§1.2ã®å†…å®¹ï¼‰
sudo cp emergency_guard.sh /opt/agriha-control/
sudo chmod +x /opt/agriha-control/emergency_guard.sh

# ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆé…ç½®ï¼ˆÂ§5.2ã®å†…å®¹ï¼‰
sudo cp system_prompt.txt /etc/agriha/

# === Step 3: unipi-daemon REST API ç–é€šç¢ºèª ===
curl http://localhost:8080/api/sensors
# â†’ CCM + DS18B20 + Misol + relay å…¨ã‚»ãƒ³ã‚µãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒè¿”ã‚‹ã“ã¨

curl http://localhost:8080/api/status
# â†’ relay_state (ch1-8), locked_out, uptime_sec ãŒè¿”ã‚‹ã“ã¨

# === Step 4: Anthropic API ç–é€šç¢ºèª ===
python3 -c "
import anthropic
c = anthropic.Anthropic()
r = c.messages.create(model='claude-haiku-4-5-20251001', max_tokens=50,
    messages=[{'role':'user','content':'hello'}])
print(r.content[0].text)
"
```

### 11.4 cronã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«

```bash
# /etc/cron.d/agriha-control

# Layer 3: LLM 1æ™‚é–“äºˆå ±ï¼ˆæ¯æ™‚0åˆ†ï¼‰
0 * * * * root flock -n /tmp/agriha_control.lock \
  /usr/bin/python3 /opt/agriha-control/agriha_control.py \
  >> /var/log/agriha/control.log 2>&1

# Layer 1: ç·Šæ€¥åœæ­¢ç›£è¦–ï¼ˆæ¯åˆ†ï¼‰
* * * * * root /opt/agriha-control/emergency_guard.sh \
  >> /var/log/agriha/emergency.log 2>&1
```

### 11.5 å‹•ä½œç¢ºèªæ‰‹é †

```bash
# 1. unipi-daemon REST APIç¢ºèª
curl http://localhost:8080/api/sensors | python3 -m json.tool
# â†’ sensors dict ã«CCM/DS18B20/Misol/relayãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚‹ã“ã¨

# 2. Anthropic APIç¢ºèª
python3 -c "import anthropic; print('OK')"

# 3. åˆ¶å¾¡ãƒ«ãƒ¼ãƒ—æ‰‹å‹•ãƒ†ã‚¹ãƒˆ
python3 /opt/agriha-control/agriha_control.py
# â†’ control_log.db ã«1ãƒ¬ã‚³ãƒ¼ãƒ‰è¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã“ã¨ç¢ºèª
sqlite3 /var/lib/agriha/control_log.db "SELECT * FROM decisions ORDER BY id DESC LIMIT 1;"

# 4. ç·Šæ€¥åœæ­¢ãƒ†ã‚¹ãƒˆ
/opt/agriha-control/emergency_guard.sh
# â†’ é–¾å€¤å†…ã§ã‚ã‚Œã°ä½•ã‚‚èµ·ããªã„ã“ã¨ç¢ºèª

# 5. cronå®Ÿè¡Œç¢ºèªï¼ˆ1æ™‚é–“å¾…ã¤ã€ã¾ãŸã¯æ‰‹å‹•ã§cronã‚’ãƒ†ã‚¹ãƒˆï¼‰
tail -f /var/log/agriha/control.log
```

---

## 12. å‚ç…§ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

| ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ | ãƒ‘ã‚¹ | å†…å®¹ |
|------------|------|------|
| unipi-daemon | ~/unipi-agri-ha/services/unipi-daemon/ | 5ã‚¿ã‚¹ã‚¯asyncioãƒ‡ãƒ¼ãƒ¢ãƒ³ï¼ˆã‚»ãƒ³ã‚µãƒ¼+MQTT+GPIO+REST+CCMï¼‰ |
| MQTTãƒˆãƒ”ãƒƒã‚¯ä»•æ§˜ | ~/unipi-agri-ha/docs/mqtt_topic_spec.md | agriha/åå‰ç©ºé–“å®šç¾©ã€QoSã€ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ä¾‹ |
| LLMåˆ¶å¾¡ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ— | ~/unipi-agri-ha/docs/llm_control_roadmap.md | Phase3.5-6ã®å…¨ä½“åƒ |
| æ–°ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆæ›¸ | ~/unipi-agri-ha/docs/mqtt_remote_arch.md | ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯/UniPi |
| ä½œç‰©çŒæ°´è¨­å®š | ~/unipi-agri-ha/config/crop_irrigation.yaml | ã‚¹ãƒ†ãƒ¼ã‚¸åˆ¥ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ |
| LLMãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã‚·ãƒŠãƒªã‚ª | ~/unipi-agri-ha/docs/llm_benchmark_scenarios.md | LINE Botåˆ¤æ–­åŠ›ãƒ†ã‚¹ãƒˆ |
| uecs-ccm-mcpï¼ˆå‚è€ƒï¼‰ | ~/uecs-ccm-mcp/ | CCMå—ä¿¡ãƒ†ã‚¹ãƒˆãƒ„ãƒ¼ãƒ«ï¼ˆåˆ¶å¾¡ã«ã¯ä½¿ç”¨ã—ãªã„ï¼‰ |

---

## ä»˜éŒ²A: v2.0â†’v3.0 å¤‰æ›´å±¥æ­´

### A.1 ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å¤‰æ›´ã®èƒŒæ™¯

2026-02-28ã®æ®¿ã¨ã®è¨­è¨ˆè­°è«–ã§ã€æ¸©å®¤LLMåˆ¶å¾¡ã®æ ¹æœ¬æ€æƒ³ãŒè»¢æ›ã•ã‚ŒãŸã€‚

1. **ä¸‰å±¤æ§‹é€ ã®å°å…¥**: LLMã¯ã€ŒçŸ¥æµã€å±¤ã¨ã—ã¦æœ€ä¸Šä½ã«ä½ç½®ã—ã€ä¸‹ä½å±¤ï¼ˆãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã€ç·Šæ€¥åœæ­¢ï¼‰ãŒç‹¬ç«‹å‹•ä½œã™ã‚‹è¨­è¨ˆã«å¤‰æ›´
2. **LLMè²¬å‹™ã®é™å®š**: LLMã®åˆ¤æ–­ã¯CO2åˆ¶å¾¡ã¨éœ²ç‚¹ç®¡ç†ã®2å ´é¢ã®ã¿ã€‚çŒæ°´ãƒ»å´çª“ã®åŸºæœ¬åˆ¶å¾¡ã¯ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã«å§”è­²
3. **1æ™‚é–“äºˆå ±æ–¹å¼**: cron 5åˆ†/10åˆ†é–“éš”ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åˆ¶å¾¡ã‹ã‚‰ã€1æ™‚é–“äºˆå ±+è¨ˆç”»å®Ÿè¡Œæ–¹å¼ã«å¤‰æ›´
4. **ç·Šæ€¥ç³»çµ±ã®LLMåˆ†é›¢**: ç·Šæ€¥åœæ­¢ã¨LINEé€šçŸ¥ã‚’LLMã‹ã‚‰å®Œå…¨åˆ†é›¢
5. **æ€’ã‚Šé§†å‹•é–‹ç™º**: è¾²å®¶ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’system_prompt.txtã«è“„ç©ã™ã‚‹ä»•çµ„ã¿ã‚’æ­£å¼å°å…¥
6. **LLMè‡ªç„¶æ¸›è¡°ãƒ¢ãƒ‡ãƒ«**: LLMä¾å­˜åº¦ãŒæ™‚é–“ã¨ã¨ã‚‚ã«è‡ªç„¶æ¸›è¡°ã™ã‚‹ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—ã‚’ç­–å®š
7. **ç·Šæ€¥åœæ­¢é–¾å€¤ã®è¦‹ç›´ã—**: Layer 1ã®ç·Šæ€¥åœæ­¢é–¾å€¤ã‚’40â„ƒ/5â„ƒâ†’27â„ƒ/16â„ƒã«å¤‰æ›´ï¼ˆè¾²å®¶ã®å®Ÿé‹ç”¨ã«å³ã—ãŸç¾å®Ÿçš„é–¾å€¤ï¼‰
8. **astralæ—¥æ™‚æ³¨å…¥**: LLMã¯è‡ªåŠ›ã§æ—¥æ™‚ãƒ»æ—¥ç…§æ¡ä»¶ã‚’æŠŠæ¡ä¸å¯ã®ãŸã‚ã€å…¨APIçµŒè·¯ã«astralï¼ˆæ—¥ã®å‡º/æ—¥æ²¡ï¼‰+æ™‚é–“å¸¯4åŒºåˆ†ã‚’æ³¨å…¥

### A.2 å»ƒæ­¢ã•ã‚ŒãŸè¨­è¨ˆè¦ç´ 

| v2.0 è¨­è¨ˆè¦ç´  | å»ƒæ­¢ç†ç”± |
|--------------|---------|
| LFM2.5 (llama-server) | å¯¾è©±èƒ½åŠ›ä¸è¶³ã€‚Claude Haiku APIã«å…¨é¢ç§»è¡Œï¼ˆ2026-02-23æ®¿è£å®šï¼‰ |
| nuc.local (Intel N150) | RPi (10.10.0.10)ã«åˆ¶å¾¡ã‚’ä¸€æœ¬åŒ–ã€‚ä¸­é–“å±¤ä¸è¦ |
| cron 5åˆ†é–“éš” | 1æ™‚é–“äºˆå ±æ–¹å¼ã«å¤‰æ›´ï¼ˆã‚³ã‚¹ãƒˆå‰Šæ¸›+è¨­è¨ˆç°¡ç´ åŒ–ï¼‰ |
| nipogiä¸­é–“å±¤ | RPiâ†’Claude APIç›´çµã€‚ä¸­é–“ã‚µãƒ¼ãƒãƒ¼ä¸è¦ |
| llama-server (localhost:8081) | Anthropic API (HTTPS)ã«å…¨é¢ç§»è¡Œ |
| N150ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ï¼ˆÂ§5æ—§ï¼‰ | ãƒ­ãƒ¼ã‚«ãƒ«LLMæ¨è«–ä¸è¦ã€‚ã‚¯ãƒ©ã‚¦ãƒ‰APIå¿œç­”ã¯æ•°ç§’ |
| Ollamaã‚·ãƒ£ãƒ‰ãƒ¼ãƒ¢ãƒ¼ãƒ‰ | 2026-02-24æ®¿åˆ¤æ–­ã§åœæ­¢ã€‚vx2ã¯ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯å°‚ç”¨ã«è»¢ç”¨ |
| ç·Šæ€¥åœæ­¢é–¾å€¤ 40â„ƒ/5â„ƒ | 27â„ƒ/16â„ƒã«å¤‰æ›´ã€‚è¾²å®¶ã®å®Ÿé‹ç”¨ã«å³ã—ãŸç¾å®Ÿçš„é–¾å€¤ |

### A.3 æ–°è¦è¿½åŠ ã•ã‚ŒãŸè¨­è¨ˆè¦ç´ 

| v3.0 è¨­è¨ˆè¦ç´  | èª¬æ˜ |
|--------------|------|
| ä¸‰å±¤åˆ¶å¾¡ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼ˆÂ§1ï¼‰ | çˆ†ç™º/ã‚¬ãƒ ãƒ†/çŸ¥æµã®3å±¤ã€å„å±¤ç‹¬ç«‹å‹•ä½œä¿è¨¼ |
| LLMè²¬å‹™ç¯„å›²ï¼ˆÂ§2ï¼‰ | CO2åˆ¶å¾¡ã¨éœ²ç‚¹ç®¡ç†ã®2å ´é¢ã«é™å®š |
| 1æ™‚é–“äºˆå ±+ç·Šæ€¥ãƒ•ãƒ©ã‚°æ–¹å¼ï¼ˆÂ§3ï¼‰ | cronæ¯æ™‚äºˆå ±+è¨ˆç”»å®Ÿè¡Œ+ç·Šæ€¥å‰²ã‚Šè¾¼ã¿ |
| Claude Haiku APIæ¥ç€å±¤ï¼ˆÂ§4ï¼‰ | Anthropic SDKã€RPiã‹ã‚‰ç›´æ¥HTTPS |
| LLMè‡ªç„¶æ¸›è¡°ãƒ¢ãƒ‡ãƒ«ï¼ˆÂ§7ï¼‰ | åˆæœŸâ†’ä¸­æœŸâ†’æˆç†ŸæœŸã®ä¸‰æ®µéšã€æœ€çµ‚çš„ã«LLMä¸è¦åŒ– |
| æ€’ã‚Šé§†å‹•é–‹ç™ºï¼ˆÂ§5.3ï¼‰ | è¾²å®¶ã‚¯ãƒ¬ãƒ¼ãƒ â†’system_prompt.txtè“„ç©â†’åˆ¶å¾¡ãƒ­ã‚¸ãƒƒã‚¯ |
| æ©Ÿèƒ½å„ªå…ˆé †ä½ï¼ˆæ¦‚è¦ï¼‰ | ãƒªãƒ¢ãƒ¼ãƒˆåˆ¶å¾¡â†’çŠ¶æ…‹ç¢ºèªâ†’ç•°å¸¸é€šçŸ¥â†’è‡ªå‹•åˆ¶å¾¡ |
| emergency_guard.shï¼ˆÂ§1.2, Â§8ï¼‰ | LLMéä¾å­˜ã®ç·Šæ€¥åœæ­¢+LINEé€šçŸ¥ |
| Layer S3: ã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¨ˆç”»ï¼ˆÂ§6.1ï¼‰ | current_plan.json ã«ã‚ˆã‚‹1æ™‚é–“è¨ˆç”»ç®¡ç† |
| 4å±¤å®‰å…¨ãƒ¢ãƒ‡ãƒ«ï¼ˆÂ§8.1ï¼‰ | ç‰©ç†å±¤+ç·Šæ€¥åœæ­¢(ifæ–‡)+LLMãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ+ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ |
| astralæ—¥æ™‚æ³¨å…¥ï¼ˆÂ§4.3ï¼‰ | æ—¥ã®å‡º/æ—¥æ²¡+æ™‚é–“å¸¯4åŒºåˆ†ã‚’LLMãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«è‡ªå‹•æ³¨å…¥ |
| ç·Šæ€¥åœæ­¢é–¾å€¤27â„ƒ/16â„ƒï¼ˆÂ§1.2, Â§8ï¼‰ | æ—§é–¾å€¤40â„ƒ/5â„ƒã‹ã‚‰è¾²å®¶å®Ÿé‹ç”¨ã«å³ã—ãŸå€¤ã«å¤‰æ›´ |

### A.4 ç¶™ç¶šåˆ©ç”¨ã•ã‚Œã‚‹è¨­è¨ˆè¦ç´ 

| è¨­è¨ˆè¦ç´  | å¤‰æ›´æœ‰ç„¡ |
|---------|---------|
| agriha_control.py | APIå‘¼ã³å‡ºã—å…ˆã‚’llama-serverâ†’Claude Haiku APIã«å¤‰æ›´ã€croné–“éš”ã‚’5åˆ†â†’1æ™‚é–“ã«å¤‰æ›´ |
| ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­è¨ˆï¼ˆÂ§5ï¼‰ | [G]ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¿½åŠ ï¼ˆ1æ™‚é–“äºˆå ±å‡ºåŠ›å½¢å¼ï¼‰ã€[E]ã«æ€’ã‚Šé§†å‹•é–‹ç™ºã‚’æ­£å¼å°å…¥ |
| åˆ¤æ–­å±¥æ­´DB control_log.dbï¼ˆÂ§6ï¼‰ | Layer S3ï¼ˆcurrent_plan.jsonï¼‰ã‚’è¿½åŠ  |
| UniPi I2Cãƒªãƒ¬ãƒ¼ch1-8ï¼ˆÂ§9, Â§10ï¼‰ | å¤‰æ›´ãªã— |
| unipi-daemon REST API | å¤‰æ›´ãªã— |
| CommandGate å®‰å…¨æ©Ÿæ§‹ | å¤‰æ›´ãªã—ï¼ˆLayer S-1ã¨ã—ã¦ä½ç½®ã¥ã‘æ˜ç¢ºåŒ–ï¼‰ |
| MqttRelayBridge duration_sec | å¤‰æ›´ãªã—ï¼ˆLayer S-4ã¨ã—ã¦ä½ç½®ã¥ã‘æ˜ç¢ºåŒ–ï¼‰ |
