# VPS上の既存 docker-compose.yml に追記するスニペット
# 使い方: 既存docker-compose.ymlのservices/volumes配下に以下を追記
#
# 既存サービス: InfluxDB, Grafana, Telegraf, WireGuard
# 追加: Ollama (qwen2.5:1.5b), LINE Bot (FastAPI)
#
# ⚠️ 注意:
# - .env ファイルは事前に linebot/.env として作成（.env.example を参考に）
# - Qwen2.5 1.5B Q4 は CPU で約1.5GB RAM 使用
# - VPS メモリ残量を確認してから起動
#
# HTTPS対応 (LINE Webhook はHTTPS必須):
# - ドメインあり → Let's Encrypt (certbot) または Cloudflare Tunnel 推奨
# - ドメインなし → ngrok (開発・テスト用) が現実的
#   ngrok: docker run -e NGROK_AUTHTOKEN=<token> ngrok/ngrok http 8443

services:
  ollama:
    image: ollama/ollama:latest
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11434/api/tags"]
      interval: 30s
      timeout: 10s
      retries: 3

  linebot:
    build: ./linebot
    ports:
      - "8443:8443"
    env_file:
      - ./linebot/.env
    environment:
      - OLLAMA_URL=http://ollama:11434
    depends_on:
      ollama:
        condition: service_healthy
    restart: unless-stopped

volumes:
  ollama_data:

# --- デプロイ手順メモ ---
# 1. VPSにSSHログイン
# 2. git pull origin main
# 3. cp linebot/.env.example linebot/.env
# 4. linebot/.env に LINE_CHANNEL_SECRET と LINE_CHANNEL_ACCESS_TOKEN を記入
# 5. docker compose up -d ollama linebot
# 6. docker exec <ollama_container> ollama pull qwen2.5:1.5b
# 7. LINE Developers コンソールで Webhook URL を設定:
#    https://<your-domain>/callback  または  https://<ngrok-url>/callback
# 8. curl https://<your-domain>/health でヘルスチェック
